=========================================
FILE: lib\core\constants\app_constants.dart
=========================================
class AppConstants {
  // UI Dimensions
  static const double kListItemHeight = 72.0;
  static const double kListTopPadding = 16.0;

  // Auto Scroll Settings
  static const double kAutoScrollZone = 50.0;
  static const double kAutoScrollStep = 20.0;
  static const int kAutoScrollDurationMs = 30;
}



=========================================
FILE: lib\core\mixins\auto_scroll_mixin.dart
=========================================
import 'dart:async';
import 'package:flutter/material.dart';
import '../constants/app_constants.dart';

mixin AutoScrollMixin<T extends StatefulWidget> on State<T> {
  Timer? _autoScrollTimer;
  Offset? lastLocalPosition;
  int? dragStartIndex;

  ScrollController get scrollController;
  int get itemCount;

  // Abstract method to be implemented by consumers to perform the actual selection
  void onSelectionRangeUpdate(int start, int end);

  @override
  void dispose() {
    stopAutoScroll();
    super.dispose();
  }

  void handleAutoScroll(Offset localPosition, double height) {
    if (localPosition.dy < AppConstants.kAutoScrollZone) {
      _startAutoScroll(-AppConstants.kAutoScrollStep);
    } else if (localPosition.dy > height - AppConstants.kAutoScrollZone) {
      _startAutoScroll(AppConstants.kAutoScrollStep);
    } else {
      stopAutoScroll();
    }
  }

  void _startAutoScroll(double step) {
    if (_autoScrollTimer != null && _autoScrollTimer!.isActive) return;

    _autoScrollTimer = Timer.periodic(
      const Duration(milliseconds: AppConstants.kAutoScrollDurationMs),
      (timer) {
        if (!scrollController.hasClients) {
          stopAutoScroll();
          return;
        }

        final currentOffset = scrollController.offset;
        final newOffset = currentOffset + step;

        if (newOffset < 0 ||
            newOffset > scrollController.position.maxScrollExtent) {
          stopAutoScroll();
          return;
        }

        scrollController.jumpTo(newOffset);

        // Sync selection while scrolling
        if (dragStartIndex != null && lastLocalPosition != null) {
          _updateSelection(lastLocalPosition!);
        }
      },
    );
  }

  void stopAutoScroll() {
    _autoScrollTimer?.cancel();
    _autoScrollTimer = null;
  }

  double get contentHeaderHeight => 0.0;
  double get listTopPadding => AppConstants.kListTopPadding;

  int calculateIndex(Offset localPosition) {
    if (!scrollController.hasClients) return 0;

    final totalOffset =
        localPosition.dy +
        scrollController.offset -
        listTopPadding -
        contentHeaderHeight;

    int index = (totalOffset / AppConstants.kListItemHeight).floor();
    return index;
  }

  void _updateSelection(Offset localPosition) {
    if (dragStartIndex == null) return;

    int currentIndex = calculateIndex(localPosition);
    if (currentIndex < 0) currentIndex = 0;
    if (currentIndex >= itemCount) currentIndex = itemCount - 1;

    onSelectionRangeUpdate(dragStartIndex!, currentIndex);
  }

  void handleDragStart(Offset localPosition) {
    lastLocalPosition = localPosition;
    dragStartIndex = calculateIndex(localPosition);
  }

  void handleDragUpdate(Offset localPosition, double height) {
    lastLocalPosition = localPosition;
    handleAutoScroll(localPosition, height);
    _updateSelection(localPosition);
  }

  void handleDragEnd() {
    dragStartIndex = null;
    lastLocalPosition = null;
    stopAutoScroll();
  }
}



=========================================
FILE: lib\core\services\audio_provider.dart
=========================================
import 'package:flutter/material.dart';
import 'dart:async';
import 'dart:io';
import 'package:flutter/services.dart';
import 'package:just_audio/just_audio.dart';
import 'package:just_audio_background/just_audio_background.dart';
import 'package:on_audio_query/on_audio_query.dart';
import 'package:shared_preferences/shared_preferences.dart'
    show SharedPreferences;
import 'package:audio_session/audio_session.dart';
import 'package:rxdart/rxdart.dart';
import 'permission_service.dart';
import 'tag_editor_service.dart';
import 'lyrics_service.dart';
import 'midi_player_service.dart';

class AudioProvider extends ChangeNotifier {
  final OnAudioQuery _audioQuery = OnAudioQuery();
  AudioPlayer? __audioPlayer;
  // ConcatenatingAudioSource deprecated, avoiding storing it if possible or using alternate
  // ConcatenatingAudioSource? _playlistSource;
  // If we need to track the current playlist sources, we can use the player's sequence or a strict list.
  // For this fix, I'll remove the explicit field type if unused elsewhere or replace usage.
  // Viewing lines 880+ shows it's used to set source.
  // The warning recommends setAudioSources.
  // I will check if I can just remove this field or if I need it for playlist manipulation.
  // Given I see no other usage in the first 800 lines other than declaration, and usage in playSong clearly recreates it.
  // I will comment it out here and fix the usage site.

  AudioPlayer get _audioPlayer {
    if (__audioPlayer == null) {
      throw StateError(
        "AudioPlayer accessed before initialization! Call initialize() first.",
      );
    }
    return __audioPlayer!;
  }

  bool _isPlayerInitialized = false;
  bool get isPlayerInitialized => _isPlayerInitialized;
  final PermissionService _permissionService = PermissionService();
  final TagEditorService _tagEditorService = TagEditorService();
  final LyricsService _lyricsService = LyricsService();
  final MidiPlayerService _midiPlayer = MidiPlayerService();

  List<SongModel> _songs = [];
  List<SongModel> get songs => _songs;

  List<AlbumModel> _albums = [];

  List<AlbumModel> get albums => _albums;

  List<ArtistModel> _artists = [];
  List<ArtistModel> get artists => _artists;

  List<PlaylistModel> _playlists = [];
  List<PlaylistModel> get playlists => _playlists;

  List<GenreModel> _genres = [];
  List<GenreModel> get genres => _genres;

  List<String> get folders {
    final paths = _songs
        .map((s) => Directory(s.data).parent.path)
        .toSet()
        .toList();
    paths.sort();
    return paths;
  }

  List<int> _favoriteSongIds = [];
  List<int> get favoriteSongIds => _favoriteSongIds;
  List<SongModel> get favoriteSongs =>
      _songs.where((s) => _favoriteSongIds.contains(s.id)).toList();

  bool _isLoading = false;
  bool get isLoading => _isLoading;

  bool _hasPermission = false;
  bool get hasPermission => _hasPermission;

  SongModel? _currentSong;
  SongModel? get currentSong => _currentSong;

  String? _currentLyrics;
  String? get currentLyrics => _currentLyrics;

  bool _isPlaying = false;
  bool get isPlaying => _isPlaying;

  Duration _duration = Duration.zero;
  Duration get duration => _duration;

  Duration _position = Duration.zero;
  Duration get position => _position;

  int? get audioSessionId => __audioPlayer?.androidAudioSessionId;

  bool _isSelectionMode = false;
  bool get isSelectionMode => _isSelectionMode;
  bool _isDraggingSelection = false;
  bool get isDraggingSelection => _isDraggingSelection;

  final Set<int> _selectedSongIds = {};
  Set<int> get selectedSongIds => _selectedSongIds;

  bool _isShuffleMode = false;
  bool get isShuffleMode => _isShuffleMode;

  LoopMode _loopMode = LoopMode.off;
  LoopMode get loopMode => _loopMode;

  Timer? _sleepTimer;
  Duration? _sleepTimerRemaining;
  Duration? get sleepTimerRemaining => _sleepTimerRemaining;
  bool get isSleepTimerActive => _sleepTimer != null;

  SongSortType? _sortType = SongSortType.DATE_ADDED;
  OrderType _orderType = OrderType.DESC_OR_GREATER;

  int? _lastPlayedId;
  int _customSortType = 0;
  final Map<String, int> _playCounts = {};

  Stream<PositionData> get positionDataStream {
    if (__audioPlayer == null) {
      return Stream.value(
        PositionData(Duration.zero, Duration.zero, Duration.zero),
      );
    }
    return Rx.combineLatest3<Duration, Duration, Duration?, PositionData>(
      _audioPlayer.positionStream,
      _audioPlayer.bufferedPositionStream,
      _audioPlayer.durationStream,
      (position, bufferedPosition, duration) =>
          PositionData(position, bufferedPosition, duration ?? Duration.zero),
    );
  }

  AudioProvider() {
    // Initialization deferred to ensure JustAudioBackground is ready
  }

  Future<void> initialize() async {
    debugPrint("DEBUG: AudioProvider: Starting initialization...");
    // REMOVED: if (_hasPermission) return; - This was causing a crash because it skipped player initialization
    try {
      await _loadPlayCounts().timeout(
        const Duration(seconds: 5),
        onTimeout: () => debugPrint("Play counts load timed out"),
      );
      await _loadFavorites();
      if (!_isPlayerInitialized) {
        await _initAudioPlayer();
      }

      // Add Error Listener for Sequence Errors
      _audioPlayer.playbackEventStream.listen(
        (event) {
          // Handle potential errors here if needed
        },
        onError: (Object e, StackTrace st) {
          if (e is PlatformException && e.code == "0") {
            debugPrint(
              "DEBUG: AudioProvider: Source error detected. Skipping song...",
            );
            playNext();
          }
        },
      );

      _audioPlayer.sequenceStateStream.listen((sequenceState) {
        if (sequenceState?.currentSource != null) {
          final tag = sequenceState!.currentSource!.tag;
          if (tag is MediaItem) {
            final songId = int.tryParse(tag.id);
            if (songId != null && songId != _lastPlayedId) {
              _lastPlayedId = songId;
              _incrementPlayCount(songId);
              try {
                final song = _songs.firstWhere((s) => s.id == songId);
                _currentSong = song;
                notifyListeners();
              } catch (e) {
                debugPrint("Playing song not in current list: $songId");
              }
            }
          }
        }
      });

      checkAndRequestPermissions();
    } catch (e) {
      debugPrint("AudioProvider Init Error: $e");
    }
  }

  Future<void> _loadPlayCounts() async {
    final prefs = await SharedPreferences.getInstance();
    final keys = prefs.getKeys();
    for (var key in keys) {
      if (key.startsWith('play_count_')) {
        final id = key.replaceFirst('play_count_', '');
        _playCounts[id] = prefs.getInt(key) ?? 0;
      }
    }
  }

  Future<void> _incrementPlayCount(int songId) async {
    final key = songId.toString();
    _playCounts[key] = (_playCounts[key] ?? 0) + 1;
    final prefs = await SharedPreferences.getInstance();
    await prefs.setInt('play_count_$key', _playCounts[key]!);
  }

  Future<void> _loadFavorites() async {
    try {
      final prefs = await SharedPreferences.getInstance();
      final List<String>? stored = prefs.getStringList('favorite_songs');
      if (stored != null) {
        _favoriteSongIds = stored.map((e) => int.parse(e)).toList();
        notifyListeners();
      }
    } catch (e) {
      debugPrint("Error loading favorites: $e");
    }
  }

  Future<void> toggleFavorite(int songId) async {
    if (_favoriteSongIds.contains(songId)) {
      _favoriteSongIds.remove(songId);
    } else {
      _favoriteSongIds.add(songId);
    }
    notifyListeners();
    try {
      final prefs = await SharedPreferences.getInstance();
      await prefs.setStringList(
        'favorite_songs',
        _favoriteSongIds.map((e) => e.toString()).toList(),
      );
    } catch (e) {
      debugPrint("Error saving favorites: $e");
    }
  }

  bool isFavorite(int songId) => _favoriteSongIds.contains(songId);

  Map<String, List<SongModel>> groupSongsByArtist() {
    final Map<String, List<SongModel>> groups = {};
    for (var song in _songs) {
      final artist = song.artist ?? "Bilinmeyen Sanatçı";
      groups.putIfAbsent(artist, () => []).add(song);
    }
    return groups;
  }

  Map<String, List<SongModel>> groupSongsByAlbum() {
    final Map<String, List<SongModel>> groups = {};
    for (var song in _songs) {
      final album = song.album ?? "Bilinmeyen Albüm";
      groups.putIfAbsent(album, () => []).add(song);
    }
    return groups;
  }

  Map<String, List<SongModel>> groupSongsByGenre() {
    final Map<String, List<SongModel>> groups = {};
    for (var song in _songs) {
      final genre = song.genre ?? "Bilinmeyen Tür";
      groups.putIfAbsent(genre, () => []).add(song);
    }
    return groups;
  }

  Timer? _pollingTimer; // Add this field

  @override
  void dispose() {
    _pollingTimer?.cancel();
    _sleepTimer?.cancel();
    _audioPlayer.dispose();
    _midiPlayer
        .stop(); // Assuming stop handles cleanup or no explicit dispose needed for singleton service
    super.dispose();
  }

  Future<void> _initAudioPlayer() async {
    if (__audioPlayer != null) return;

    debugPrint(
      "DEBUG: AudioProvider: Starting robust AudioPlayer initialization...",
    );

    int retryCount = 0;
    const maxRetries = 10;

    while (retryCount < maxRetries) {
      try {
        debugPrint(
          "DEBUG: AudioProvider: Attempting AudioPlayer construction (Attempt ${retryCount + 1})...",
        );
        __audioPlayer = AudioPlayer();
        _isPlayerInitialized = true;
        debugPrint(
          "DEBUG: AudioProvider: AudioPlayer construction successful.",
        );
        break;
      } catch (e) {
        retryCount++;
        final errorStr = e.toString();
        debugPrint(
          "DEBUG: AudioProvider: Construction attempt $retryCount failed: $e",
        );

        if (errorStr.contains('_audioHandler') ||
            errorStr.contains('LateInitializationError')) {
          if (retryCount >= maxRetries) {
            debugPrint(
              "DEBUG: AudioProvider: Max retries reached. Initialization failed.",
            );
            rethrow;
          }
          debugPrint(
            "DEBUG: AudioProvider: Background handler not ready. Retrying in 500ms...",
          );
          await Future.delayed(const Duration(milliseconds: 500));
        } else {
          debugPrint(
            "DEBUG: AudioProvider: Non-recoverable construction error: $e",
          );
          rethrow;
        }
      }
    }

    try {
      final session = await AudioSession.instance;
      await session.configure(const AudioSessionConfiguration.music());
    } catch (e) {
      debugPrint("DEBUG: AudioSession Config Error: $e");
    }

    _audioPlayer.playerStateStream.listen((playerState) {
      _isPlaying = playerState.playing;
      notifyListeners();
    });

    _audioPlayer.durationStream.listen((newDuration) {
      if (newDuration != null) {
        _duration = newDuration;
        // notifyListeners(); // Removed to prevent high-frequency rebuilds
      }
    });

    _audioPlayer.positionStream.listen((newPosition) {
      _position = newPosition;
      // notifyListeners(); // Removed to prevent high-frequency rebuilds
    });

    _audioPlayer.processingStateStream.listen((state) {
      if (state == ProcessingState.completed) {
        if (!isMidiPlaying) {
          playNext();
        }
      }
    });

    // Unified Duration/Position Polling
    _pollingTimer?.cancel(); // Cancel existing if any
    _pollingTimer = Timer.periodic(const Duration(milliseconds: 500), (
      timer,
    ) async {
      // Clean up if player is disposed (good practice)
      if (!isPlayerInitialized) {
        timer.cancel();
        return;
      }

      // MIDI Handling
      if (isMidiPlaying && _isPlaying) {
        final pos = await _midiPlayer.getPosition();
        final dur = await _midiPlayer.getDuration();
        final newPosition = Duration(milliseconds: pos);

        // Update internal state but DO NOT notify listeners just for position
        if (newPosition != _position) {
          _position = newPosition;
          // shouldNotify = true; // CAUTION: Do not notify for position!
        }

        if (dur > 0) {
          final newDuration = Duration(milliseconds: dur);
          if (newDuration != _duration) {
            _duration = newDuration;
            // Only notify if duration changes significantly, but usually streams handle this.
            // For MIDI, we might need one initial notification, but not constant.
            // shouldNotify = true;
          }
        }

        if (dur > 0 && pos >= dur - 500) {
          await _midiPlayer.stop();
          playNext();
          return; // playNext will notify
        }
      }
    });
  }

  Future<void> checkAndRequestPermissions() async {
    _isLoading = true;
    notifyListeners();
    try {
      _hasPermission = await _permissionService.requestStoragePermission();
      if (_hasPermission) {
        await fetchSongs();
        await fetchAlbums();
        await fetchPlaylists();
        await fetchPlaylists();
        await fetchGenres();
        await fetchArtists();
        // MIDI scan is now non-blocking to speed up startup
        _scanForMidiFilesInBackground();
      }
    } catch (e) {
      debugPrint("Error requesting permissions: $e");
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> _scanForMidiFilesInBackground() async {
    debugPrint("DEBUG: Starting non-blocking MIDI scan...");
    try {
      List<SongModel> midiSongs = await _scanForMidiFiles();
      if (midiSongs.isNotEmpty) {
        _songs.addAll(midiSongs);
        _songs = _songs.toSet().toList(); // Ensure uniqueness
        notifyListeners();
        debugPrint(
          "DEBUG: MIDI scan complete. Added ${midiSongs.length} songs.",
        );
      }
    } catch (e) {
      debugPrint("DEBUG: MIDI background scan error: $e");
    }
  }

  Future<void> fetchSongs() async {
    try {
      List<SongModel> fetchedSongs = await _audioQuery.querySongs(
        sortType: _sortType,
        orderType: _orderType,
        uriType: UriType.EXTERNAL,
        ignoreCase: true,
      );
      // Removed blocking MIDI scan from main fetch

      if (_customSortType != 0) {
        fetchedSongs.sort((a, b) {
          int countA = _playCounts[a.id.toString()] ?? 0;
          int countB = _playCounts[b.id.toString()] ?? 0;
          return _customSortType == 1
              ? countB.compareTo(countA)
              : countA.compareTo(countB);
        });
      }
      _songs = fetchedSongs;
    } catch (e) {
      debugPrint("Error fetching songs: $e");
      _songs = [];
    }
    notifyListeners();
  }

  Future<List<SongModel>> _scanForMidiFiles() async {
    List<SongModel> midiSongs = [];
    if (!Platform.isAndroid) return midiSongs;
    final List<String> pathsToScan = [
      '/storage/emulated/0/Music',
      '/storage/emulated/0/Download',
      '/storage/emulated/0/Audio',
      '/storage/emulated/0/Documents',
    ];

    for (final path in pathsToScan) {
      final dir = Directory(path);
      if (await dir.exists()) {
        try {
          await for (final entity in dir.list(
            recursive: true,
            followLinks: false,
          )) {
            if (entity is File) {
              final String filePath = entity.path.toLowerCase();
              if (filePath.endsWith('.mid') || filePath.endsWith('.midi')) {
                int id = entity.path.hashCode;
                String title = entity.uri.pathSegments.last;
                if (title.contains('.')) {
                  title = title.substring(0, title.lastIndexOf('.'));
                }
                midiSongs.add(
                  SongModel({
                    "_id": id,
                    "_data": entity.path,
                    "title": title,
                    "artist": "MIDI File",
                    "album": "Unknown Album",
                    "duration": 0,
                    "is_music": true,
                  }),
                );
              }
            }
          }
        } catch (e) {
          debugPrint("Error scanning MIDI: $e");
        }
      }
    }
    return midiSongs;
  }

  Future<void> fetchAlbums() async {
    try {
      _albums = await _audioQuery.queryAlbums(
        sortType: AlbumSortType.ALBUM,
        orderType: OrderType.ASC_OR_SMALLER,
        uriType: UriType.EXTERNAL,
        ignoreCase: true,
      );
    } catch (e) {
      debugPrint("Error fetching albums: $e");
      _albums = [];
    }
    notifyListeners();
  }

  List<SongModel> getSongsFromAlbum(int albumId) =>
      _songs.where((song) => song.albumId == albumId).toList();

  Future<void> fetchPlaylists() async {
    try {
      _playlists = await _audioQuery.queryPlaylists(
        sortType: PlaylistSortType.DATE_ADDED,
        orderType: OrderType.DESC_OR_GREATER,
        uriType: UriType.EXTERNAL,
        ignoreCase: true,
      );
    } catch (e) {
      debugPrint("Error fetching playlists: $e");
      _playlists = [];
    }
    notifyListeners();
  }

  Future<void> fetchArtists() async {
    try {
      _artists = await _audioQuery.queryArtists(
        sortType: ArtistSortType.ARTIST,
        orderType: OrderType.ASC_OR_SMALLER,
        uriType: UriType.EXTERNAL,
        ignoreCase: true,
      );
      notifyListeners();
    } catch (e) {
      debugPrint("Error fetching artists: $e");
    }
  }

  Future<void> fetchGenres() async {
    try {
      _genres = await _audioQuery.queryGenres(
        sortType: GenreSortType.GENRE,
        orderType: OrderType.ASC_OR_SMALLER,
        uriType: UriType.EXTERNAL,
        ignoreCase: true,
      );
    } catch (e) {
      debugPrint("Error fetching genres: $e");
      _genres = [];
    }
    notifyListeners();
  }

  Future<List<SongModel>> getSongsFromGenre(int genreId) async {
    try {
      return await _audioQuery.queryAudiosFrom(
        AudiosFromType.GENRE_ID,
        genreId,
        sortType: SongSortType.TITLE,
        orderType: OrderType.ASC_OR_SMALLER,
        ignoreCase: true,
      );
    } catch (e) {
      debugPrint("Error from genre: $e");
      return [];
    }
  }

  List<SongModel> getSongsFromFolder(String folderPath) => _songs
      .where((song) => Directory(song.data).parent.path == folderPath)
      .toList();

  Future<List<SongModel>> getSongsFromPlaylist(int playlistId) async {
    try {
      return await _audioQuery.queryAudiosFrom(
        AudiosFromType.PLAYLIST,
        playlistId,
        sortType: SongSortType.TITLE,
        orderType: OrderType.ASC_OR_SMALLER,
        ignoreCase: true,
      );
    } catch (e) {
      debugPrint("Error from playlist: $e");
      return [];
    }
  }

  Future<void> createPlaylist(String name) async {
    try {
      await _audioQuery.createPlaylist(name);
      await fetchPlaylists();
    } catch (e) {
      debugPrint("Error create playlist: $e");
    }
  }

  Future<void> addToPlaylist(int playlistId, int audioId) async {
    try {
      await _audioQuery.addToPlaylist(playlistId, audioId);
      await fetchPlaylists();
    } catch (e) {
      debugPrint("Error add to playlist: $e");
    }
  }

  Future<void> addSongsToPlaylist(int playlistId, List<int> songIds) async {
    try {
      for (int id in songIds) {
        await _audioQuery.addToPlaylist(playlistId, id);
      }
      await fetchPlaylists();
    } catch (e) {
      debugPrint("Error adding songs to playlist: $e");
    }
  }

  Future<void> deletePlaylist(int playlistId) async {
    try {
      await _audioQuery.removePlaylist(playlistId);
      await fetchPlaylists();
    } catch (e) {
      debugPrint("Error delete playlist: $e");
    }
  }

  Future<void> createSmartPlaylistFromGenre(GenreModel genre) async {
    try {
      _isLoading = true;
      notifyListeners();

      // 1. Bu etikete (türe) ait tüm şarkıları çek
      final genreSongs = await getSongsFromGenre(genre.id);
      if (genreSongs.isEmpty) {
        _isLoading = false;
        notifyListeners();
        return;
      }

      // 2. Etiket adıyla yeni bir çalma listesi oluştur
      await _audioQuery.createPlaylist(genre.genre);

      // 3. Listeleri yenile ve yeni oluşturulanın ID'sini bul
      await fetchPlaylists();
      // Yeni oluşturulan listeyi ismiyle buluyoruz
      final newPlaylist = _playlists.firstWhere(
        (p) => p.playlist == genre.genre,
      );

      // 4. Tüm şarkı ID'lerini topluca listeye ekle
      for (var song in genreSongs) {
        await _audioQuery.addToPlaylist(newPlaylist.id, song.id);
      }

      await fetchPlaylists(); // Sayacı güncellemek için tekrar çek
      _isLoading = false;
      notifyListeners();
    } catch (e) {
      debugPrint("Smart Playlist Hatası: $e");
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> createSmartPlaylistFromAlbum(AlbumModel album) async {
    try {
      _isLoading = true;
      notifyListeners();

      final albumSongs = getSongsFromAlbum(album.id);
      if (albumSongs.isEmpty) {
        _isLoading = false;
        notifyListeners();
        return;
      }

      await _audioQuery.createPlaylist(album.album);
      await fetchPlaylists();

      final newPlaylist = _playlists.firstWhere(
        (p) => p.playlist == album.album,
      );

      for (var song in albumSongs) {
        await _audioQuery.addToPlaylist(newPlaylist.id, song.id);
      }

      await fetchPlaylists();
      _isLoading = false;
      notifyListeners();
    } catch (e) {
      debugPrint("Albüm listesi oluşturma hatası: $e");
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> createSmartPlaylistFromArtist(ArtistModel artist) async {
    try {
      _isLoading = true;
      notifyListeners();

      // Filter by artist ID if available, otherwise by name
      // Note: OnAudioQuery's SongModel typically has artistId.
      final artistSongs = _songs.where((s) => s.artistId == artist.id).toList();

      if (artistSongs.isEmpty) {
        // Fallback or just return
        _isLoading = false;
        notifyListeners();
        return;
      }

      await _audioQuery.createPlaylist(artist.artist);
      await fetchPlaylists();

      final newPlaylist = _playlists.firstWhere(
        (p) => p.playlist == artist.artist,
      );

      for (var song in artistSongs) {
        await _audioQuery.addToPlaylist(newPlaylist.id, song.id);
      }

      await fetchPlaylists();
      _isLoading = false;
      notifyListeners();
    } catch (e) {
      debugPrint("Sanatçı listesi oluşturma hatası: $e");
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<bool> updateSongTags({
    required SongModel song,
    required String title,
    required String artist,
    String? album,
    String? genre,
  }) async {
    try {
      final success = await _tagEditorService.updateTags(
        filePath: song.data,
        title: title,
        artist: artist,
        album: album,
        genre: genre,
      );

      if (success) {
        // Refresh appropriate lists to show new data
        await fetchSongs();
        if (album != null) await fetchAlbums();
        if (genre != null) await fetchGenres();
      }
      return success;
    } catch (e) {
      debugPrint("Error in updateSongTags: $e");
      return false;
    }
  }

  void toggleSelectionMode() {
    _isSelectionMode = !_isSelectionMode;
    if (!_isSelectionMode) {
      _selectedSongIds.clear();
      _isDraggingSelection = false;
    }
    notifyListeners();
  }

  void setDraggingSelection(bool value) {
    _isDraggingSelection = value;
    notifyListeners();
  }

  void toggleSelection(int songId) {
    if (_selectedSongIds.contains(songId)) {
      _selectedSongIds.remove(songId);
    } else {
      _selectedSongIds.add(songId);
    }
    notifyListeners();
  }

  void addSongsToSelection(List<int> songIds) {
    bool changed = false;
    for (var id in songIds) {
      if (_selectedSongIds.add(id)) {
        changed = true;
      }
    }
    if (changed) {
      notifyListeners();
    }
  }

  void selectRange(
    int startIndex,
    int endIndex, {
    List<SongModel>? sourceList,
  }) {
    if (!isSelectionMode) toggleSelectionMode();

    final targetList = sourceList ?? _songs;
    int start = startIndex < endIndex ? startIndex : endIndex;
    int end = startIndex < endIndex ? endIndex : startIndex;

    bool changed = false;
    for (int i = start; i <= end; i++) {
      if (i >= 0 && i < targetList.length) {
        if (_selectedSongIds.add(targetList[i].id)) {
          changed = true;
        }
      }
    }
    if (changed) notifyListeners();
  }

  void toggleShuffle() {
    _isShuffleMode = !_isShuffleMode;
    _audioPlayer.setShuffleModeEnabled(_isShuffleMode);
    notifyListeners();
  }

  void toggleRepeatMode() {
    if (_loopMode == LoopMode.off) {
      _loopMode = LoopMode.all;
    } else if (_loopMode == LoopMode.all) {
      _loopMode = LoopMode.one;
    } else {
      _loopMode = LoopMode.off;
    }
    _audioPlayer.setLoopMode(_loopMode);
    notifyListeners();
  }

  void setSleepTimer(Duration duration) {
    cancelSleepTimer();
    _sleepTimerRemaining = duration;
    _sleepTimer = Timer.periodic(const Duration(seconds: 1), (timer) {
      if (_sleepTimerRemaining!.inSeconds > 0) {
        _sleepTimerRemaining = Duration(
          seconds: _sleepTimerRemaining!.inSeconds - 1,
        );
        notifyListeners();
      } else {
        pause();
        cancelSleepTimer();
      }
    });
    notifyListeners();
  }

  void cancelSleepTimer() {
    _sleepTimer?.cancel();
    _sleepTimer = null;
    _sleepTimerRemaining = null;
    notifyListeners();
  }

  Future<void> deleteSelectedSongs() async {
    if (_selectedSongIds.isEmpty) return;
    try {
      for (int id in _selectedSongIds) {
        final song = _songs.firstWhere((s) => s.id == id);
        final file = File(song.data);
        if (await file.exists()) await file.delete();
      }
      _selectedSongIds.clear();
      _isSelectionMode = false;
      await fetchSongs();
    } catch (e) {
      debugPrint("Error delete songs: $e");
    }
  }

  Future<void> addSelectedToPlaylist(int playlistId) async {
    if (_selectedSongIds.isEmpty) return;
    try {
      for (int id in _selectedSongIds) {
        await addToPlaylist(playlistId, id);
      }
      _selectedSongIds.clear();
      _isSelectionMode = false;
      notifyListeners();
    } catch (e) {
      debugPrint("Error add to playlist: $e");
    }
  }

  Future<void> updateSort(dynamic sortOption) async {
    _isLoading = true;
    notifyListeners();
    try {
      if (sortOption is int) {
        _customSortType = sortOption;
        _sortType = SongSortType.TITLE;
        _orderType = OrderType.ASC_OR_SMALLER;
      } else if (sortOption is SongSortType) {
        _customSortType = 0;
        _sortType = sortOption;
        _orderType =
            (sortOption == SongSortType.DATE_ADDED ||
                sortOption == SongSortType.DURATION)
            ? OrderType.DESC_OR_GREATER
            : OrderType.ASC_OR_SMALLER;
      }
      await fetchSongs();
    } finally {
      _isLoading = false;
      notifyListeners();
    }
  }

  Future<void> _loadLyrics(String path) async {
    final lyrics = await _lyricsService.getOfflineLyrics(path);
    if (lyrics != null) {
      _currentLyrics = _lyricsService.formatLyrics(lyrics);
      notifyListeners();
    }
  }

  bool get isMidiPlaying =>
      _currentSong?.data.toLowerCase().endsWith('.mid') == true ||
      _currentSong?.data.toLowerCase().endsWith('.midi') == true;

  Future<void> playSongList(
    List<SongModel> splitSongs, {
    int initialIndex = 0,
    bool shuffle = false,
  }) async {
    if (splitSongs.isEmpty) return;

    // Update the main song list to this new list
    _songs = List.from(splitSongs);

    if (shuffle) {
      _isShuffleMode = true;
      await _audioPlayer.setShuffleModeEnabled(true);
      // If shuffling, we typically want to start playing immediately.
      // Ideally, we pick a random index or let the player handle it,
      // but to be safe and immediate, we can shuffle internally or just play index 0 of the shuffled view.
      // However, just_audio's shuffle order is hidden.
      // Simplest approach: Play the initialIndex (which might be the tapped song)
      // OR if it's a "Shuffle All" button, play a random index.

      // If "Shuffle All" (initialIndex 0 default), allow random start if logic dictates,
      // but for now we'll just play the requested index.
      // If the user hit "Shuffle Play" FAB, we probably passed a random index or 0.
      if (initialIndex == 0 && splitSongs.length > 1) {
        // Optionally randomize start for "Shuffle Play" button
        initialIndex =
            DateTime.now().millisecondsSinceEpoch % splitSongs.length;
      }
    } else {
      _isShuffleMode = false;
      await _audioPlayer.setShuffleModeEnabled(false);
    }

    notifyListeners();
    await playSong(_songs[initialIndex]);
  }

  Future<void> playSong(SongModel song) async {
    if (!_isPlayerInitialized) {
      debugPrint(
        "DEBUG: playSong: Player not initialized. Initializing now...",
      );
      await initialize();
    }
    debugPrint("DEBUG: playSong called for: ${song.title} (ID: ${song.id})");

    if (_currentSong?.id == song.id && _isPlaying) {
      debugPrint("DEBUG: playSong: Song already playing.");
      return;
    }

    _currentSong = song;
    _position = Duration.zero;
    _duration = Duration(milliseconds: song.duration ?? 0);
    _loadLyrics(song.data);
    _lastPlayedId = song.id;
    notifyListeners();

    try {
      if (isMidiPlaying) {
        await _audioPlayer.stop();
        // _playlistSource = null; // Removed
        await _midiPlayer.play(song.data);
        _isPlaying = true;
      } else {
        await _midiPlayer.stop();
        final standardSongs = _songs
            .where(
              (s) =>
                  !s.data.toLowerCase().endsWith('.mid') &&
                  !s.data.toLowerCase().endsWith('.midi'),
            )
            .toList();
        final initialIndex = standardSongs.indexWhere((s) => s.id == song.id);

        final currentSequence = _audioPlayer.sequence;
        if (currentSequence.length != standardSongs.length) {
          debugPrint("DEBUG: playSong: Rebuilding playlist source...");
          final sources = standardSongs
              .map(
                (s) => AudioSource.uri(
                  Uri.file(s.data),
                  tag: MediaItem(
                    id: s.id.toString(),
                    title: s.title,
                    artist: s.artist,
                    album: s.album,
                    artUri: Uri.parse(
                      'content://media/external/audio/media/${s.id}/albumart',
                    ),
                  ),
                ),
              )
              .toList();

          await _audioPlayer.setAudioSources(
            sources,
            initialIndex: initialIndex >= 0 ? initialIndex : 0,
          );
        } else {
          debugPrint("DEBUG: playSong: Reusing playlist sequence. Seeking...");
          if (initialIndex >= 0) {
            await _audioPlayer.seek(Duration.zero, index: initialIndex);
          }
        }

        await _audioPlayer.play();
        _isPlaying = true;
      }
    } catch (e) {
      debugPrint("Oynatma Hatası: $e");
    }
    notifyListeners();
  }

  Future<void> pause() async {
    isMidiPlaying ? await _midiPlayer.pause() : await _audioPlayer.pause();
    _isPlaying = false;
    notifyListeners();
  }

  Future<void> resume() async {
    isMidiPlaying ? await _midiPlayer.resume() : await _audioPlayer.play();
    _isPlaying = true;
    notifyListeners();
  }

  Future<void> playNext() async {
    if (isMidiPlaying) {
      if (_songs.isEmpty || _currentSong == null) return;
      int index = _songs.indexOf(_currentSong!);
      if (index < _songs.length - 1) playSong(_songs[index + 1]);
    } else {
      await _audioPlayer.seekToNext();
    }
  }

  Future<void> playPrevious() async {
    if (isMidiPlaying) {
      if (_songs.isEmpty || _currentSong == null) return;
      int index = _songs.indexOf(_currentSong!);
      if (index > 0) playSong(_songs[index - 1]);
    } else {
      await _audioPlayer.seekToPrevious();
    }
  }

  Future<void> seek(Duration pos) async {
    isMidiPlaying
        ? await _midiPlayer.seek(pos.inMilliseconds)
        : await _audioPlayer.seek(pos);
  }
}

class PositionData {
  final Duration position;
  final Duration bufferedPosition;
  final Duration duration;
  PositionData(this.position, this.bufferedPosition, this.duration);
}



=========================================
FILE: lib\core\services\lyrics_service.dart
=========================================
import 'dart:io';

class LyricsService {
  Future<String?> getOfflineLyrics(String filePath) async {
    try {
      // 1. Try finding .lrc file with same name
      final lrcPath = "${filePath.substring(0, filePath.lastIndexOf('.'))}.lrc";
      final file = File(lrcPath);
      if (await file.exists()) {
        return await file.readAsString();
      }

      // 2. Future: Could try reading from ID3 tags if audiotags supports it
      // Currently, we focus on .lrc files for offline
      return null;
    } catch (e) {
      return null;
    }
  }

  // Simple parser to remove timestamps for basic display if needed
  String formatLyrics(String rawLyrics) {
    // Remove [00:00.00] style timestamps
    return rawLyrics.replaceAll(RegExp(r'\[\d+:\d+\.\d+\]'), '').trim();
  }
}



=========================================
FILE: lib\core\services\midi_player_service.dart
=========================================
import 'package:flutter/services.dart';

class MidiPlayerService {
  static const _channel = MethodChannel('com.example.modern_music_player/midi');

  Future<void> play(String path) async {
    await _channel.invokeMethod('play', {'path': path});
  }

  Future<void> pause() async {
    await _channel.invokeMethod('pause');
  }

  Future<void> resume() async {
    await _channel.invokeMethod('resume');
  }

  Future<void> stop() async {
    await _channel.invokeMethod('stop');
  }

  Future<int> getDuration() async {
    return await _channel.invokeMethod('getDuration') ?? 0;
  }

  Future<int> getPosition() async {
    return await _channel.invokeMethod('getPosition') ?? 0;
  }

  Future<void> seek(int position) async {
    await _channel.invokeMethod('seek', {'position': position});
  }

  Future<bool> isPlaying() async {
    return await _channel.invokeMethod('isPlaying') ?? false;
  }
}



=========================================
FILE: lib\core\services\permission_service.dart
=========================================
import 'package:on_audio_query/on_audio_query.dart';
import 'package:flutter/foundation.dart';
import 'package:permission_handler/permission_handler.dart';
import 'dart:io';

class PermissionService {
  Future<bool> requestStoragePermission() async {
    if (kIsWeb) return false;

    if (Platform.isAndroid) {
      debugPrint(
        "DEBUG: PermissionService: Starting permission request sequence...",
      );

      // On Android 13+ (API 33+), we need READ_MEDIA_AUDIO
      final audioStatus = await Permission.audio.status;
      debugPrint(
        "DEBUG: PermissionService: Current audio status: $audioStatus",
      );

      if (audioStatus.isPermanentlyDenied) {
        debugPrint(
          "DEBUG: PermissionService: Audio permission permanently denied. Opening settings...",
        );
        // openAppSettings(); // Optional: You might want to show a dialog first
      }

      final requestedAudioStatus = await Permission.audio.request();
      debugPrint(
        "DEBUG: PermissionService: Requested audio status: $requestedAudioStatus",
      );

      // For older versions, we still need storage
      final storageStatus = await Permission.storage.request();
      debugPrint(
        "DEBUG: PermissionService: Requested storage status: $storageStatus",
      );

      // Notification permission for background playback
      await Permission.notification.request();

      // Check if we have at least one of the required permissions
      if (requestedAudioStatus.isGranted || storageStatus.isGranted) {
        debugPrint(
          "DEBUG: PermissionService: Success! Media/Storage permission granted.",
        );
        return true;
      }

      // Last resort: internal on_audio_query request
      final OnAudioQuery audioQuery = OnAudioQuery();
      final onAudioStatus = await audioQuery.permissionsRequest();
      debugPrint(
        "DEBUG: PermissionService: OnAudioQuery backup result: $onAudioStatus",
      );
      return onAudioStatus;
    }

    return true; // Non-Android is handled differently or assumed ok
  }
}



=========================================
FILE: lib\core\services\shazam_service.dart
=========================================
import 'package:dio/dio.dart';
import 'package:flutter/material.dart';

class ShazamService {
  final Dio _dio = Dio();
  final String _baseUrl = 'https://shazam.p.rapidapi.com';
  final String _apiKey = '5536353540msh3ce4198a9fe57dfp1afb84jsn1500fb0f91ba';
  final String _apiHost = 'shazam.p.rapidapi.com';

  Future<List<dynamic>> search(String query) async {
    try {
      final response = await _dio.get(
        '$_baseUrl/search',
        queryParameters: {
          'term': query,
          'locale': 'en-US',
          'offset': '0',
          'limit': '5',
        },
        options: Options(
          headers: {'x-rapidapi-key': _apiKey, 'x-rapidapi-host': _apiHost},
        ),
      );

      if (response.statusCode == 200) {
        // The structure usually has 'tracks' -> 'hits'
        final data = response.data;
        if (data != null &&
            data['tracks'] != null &&
            data['tracks']['hits'] != null) {
          return data['tracks']['hits'];
        }
      }
      return [];
    } catch (e) {
      debugPrint("Shazam Search Error: $e");
      return [];
    }
  }

  // Use 'auto-complete' if 'search' is deprecated or complex
  Future<List<dynamic>> autoComplete(String query) async {
    try {
      final response = await _dio.get(
        '$_baseUrl/auto-complete',
        queryParameters: {'term': query, 'locale': 'en-US'},
        options: Options(
          headers: {'x-rapidapi-key': _apiKey, 'x-rapidapi-host': _apiHost},
        ),
      );

      if (response.statusCode == 200) {
        final data = response.data;
        if (data != null && data['hints'] != null) {
          return data['hints'];
        }
      }
      return [];
    } catch (e) {
      debugPrint("Shazam AutoComplete Error: $e");
      return [];
    }
  }
}



=========================================
FILE: lib\core\services\tag_editor_service.dart
=========================================
import 'dart:io';
import 'package:audiotags/audiotags.dart';
import 'package:dio/dio.dart';
import 'package:flutter/foundation.dart';
import 'package:path_provider/path_provider.dart';

class TagEditorService {
  final Dio _dio = Dio();

  // Downloads image from URL and saves to temp file
  Future<String?> _downloadImage(String url) async {
    try {
      final tempDir = await getTemporaryDirectory();
      final savePath =
          '${tempDir.path}/temp_cover_${DateTime.now().millisecondsSinceEpoch}.jpg';
      await _dio.download(url, savePath);
      return savePath;
    } catch (e) {
      debugPrint("Error downloading image: $e");
      return null;
    }
  }

  Future<bool> updateTags({
    required String filePath,
    required String title,
    required String artist,
    String? album,
    String? genre,
    String? coverUrl,
  }) async {
    try {
      List<Picture> pictures = [];

      // 1. Prepare Cover Art if provided
      if (coverUrl != null && coverUrl.isNotEmpty) {
        final localImagePath = await _downloadImage(coverUrl);
        if (localImagePath != null) {
          try {
            final bytes = await File(localImagePath).readAsBytes();
            pictures.add(
              Picture(
                pictureType: PictureType.other,
                mimeType: MimeType.jpeg,
                bytes: bytes,
              ),
            );
          } catch (e) {
            debugPrint("Error reading image bytes: $e");
          }

          // Clean up temp
          try {
            await File(localImagePath).delete();
          } catch (_) {}
        }
      }

      // 2. Prepare Tag
      Tag tag = Tag(
        title: title,
        trackArtist: artist,
        album: album,
        genre: genre,
        pictures: pictures,
      );

      // 3. Write Metadata
      await AudioTags.write(filePath, tag);

      return true;
    } catch (e) {
      debugPrint("Error updating tags: $e");
      return false;
    }
  }
}



=========================================
FILE: lib\core\services\theme_provider.dart
=========================================
import 'package:flutter/material.dart';
import 'package:shared_preferences/shared_preferences.dart';

class ThemeProvider extends ChangeNotifier {
  String? _backgroundImagePath;
  String? get backgroundImagePath => _backgroundImagePath;

  bool _isLoading = true;
  bool get isLoading => _isLoading;

  ThemeProvider() {
    _loadSettings();
  }

  Future<void> _loadSettings() async {
    final prefs = await SharedPreferences.getInstance();
    _backgroundImagePath = prefs.getString('background_image_path');
    _isLoading = false;
    notifyListeners();
  }

  Future<void> setBackgroundImage(String? path) async {
    final prefs = await SharedPreferences.getInstance();
    if (path == null) {
      await prefs.remove('background_image_path');
    } else {
      await prefs.setString('background_image_path', path);
    }
    _backgroundImagePath = path;
    notifyListeners();
  }
}



=========================================
FILE: lib\core\theme\app_colors.dart
=========================================
import 'package:flutter/material.dart';

class AppColors {
  // Backgrounds
  static const Color background = Color(0xFF1C0101); // Deep Red/Black
  static const Color backgroundGradientStart = Color(
    0xFF2A0303,
  ); // Slightly lighter red for gradient top
  static const Color backgroundGradientEnd = Color(
    0xFF000000,
  ); // Pure black for bottom

  static const Color surface = Color(0xFF2C2C2C);
  static const Color surfaceLight = Color(0xFF333333);

  // Accents
  static const Color primary = Color(0xFFE50914); // Netflix Red / Strong Red
  static const Color primaryDark = Color(0xFF8B0000);
  static const Color heavyOrange = Color(
    0xFFB74E08,
  ); // For buttons like "Karıştır"

  // Text
  static const Color textPrimary = Color(0xFFFFFFFF);
  static const Color textSecondary = Color(0xFFB3B3B3);

  // UI Elements
  static const Color divider = Color(0xFF2A2A2A);
  static const Color error = Color(0xFFFF3B30);
}



=========================================
FILE: lib\core\theme\app_theme.dart
=========================================
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'app_colors.dart';

class AppTheme {
  static ThemeData get darkTheme {
    return ThemeData(
      useMaterial3: true,
      brightness: Brightness.dark,
      scaffoldBackgroundColor: AppColors.background,
      primaryColor: AppColors.primary,

      // Color Scheme
      colorScheme: const ColorScheme.dark(
        primary: AppColors.primary,
        secondary:
            AppColors.primary, // Re-use primary for now or use heavyOrange
        surface: AppColors.surface,
        error: AppColors.error,
        onPrimary: Colors.white,
        onSecondary: Colors.white,
        onSurface: AppColors.textPrimary,
      ),

      // Text Theme
      textTheme: GoogleFonts.outfitTextTheme(
        ThemeData.dark().textTheme.apply(
          bodyColor: AppColors.textPrimary,
          displayColor: AppColors.textPrimary,
        ),
      ),

      // AppBar Theme
      appBarTheme: const AppBarTheme(
        backgroundColor: Colors.transparent,
        elevation: 0,
        centerTitle: true,
        iconTheme: IconThemeData(color: AppColors.textPrimary),
        titleTextStyle: TextStyle(
          color: AppColors.textPrimary,
          fontSize: 20,
          fontWeight: FontWeight.w600,
        ),
      ),

      // Bottom Navigation Bar Theme
      bottomNavigationBarTheme: const BottomNavigationBarThemeData(
        backgroundColor: AppColors.surface,
        selectedItemColor: AppColors.primary,
        unselectedItemColor: AppColors.textSecondary,
        type: BottomNavigationBarType.fixed,
        elevation: 0,
      ),

      // Slider Theme
      sliderTheme: SliderThemeData(
        activeTrackColor: AppColors.primary,
        inactiveTrackColor: AppColors.surfaceLight,
        thumbColor: AppColors.primary,
        overlayColor: AppColors.primary.withValues(alpha: 0.2),
        trackHeight: 4.0,
        thumbShape: const RoundSliderThumbShape(enabledThumbRadius: 8.0),
      ),
    );
  }
}



=========================================
FILE: lib\core\widgets\gradient_background.dart
=========================================
import 'dart:io';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../services/theme_provider.dart';
import '../theme/app_colors.dart';

class GradientBackground extends StatelessWidget {
  final Widget child;

  const GradientBackground({super.key, required this.child});

  @override
  Widget build(BuildContext context) {
    return Consumer<ThemeProvider>(
      builder: (context, themeProvider, _) {
        final imagePath = themeProvider.backgroundImagePath;

        return Container(
          decoration: BoxDecoration(
            image: imagePath != null
                ? DecorationImage(
                    image: FileImage(File(imagePath)),
                    fit: BoxFit.cover,
                    colorFilter: ColorFilter.mode(
                      Colors.black.withValues(
                        alpha: 0.7,
                      ), // Darken image for readability
                      BlendMode.darken,
                    ),
                  )
                : null,
            gradient: imagePath == null
                ? const LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      AppColors.backgroundGradientStart,
                      AppColors.backgroundGradientEnd,
                    ],
                    stops: [0.0, 0.6],
                  )
                : null,
          ),
          child: child,
        );
      },
    );
  }
}



=========================================
FILE: lib\core\widgets\song_list_tile.dart
=========================================
import 'package:flutter/material.dart';
import 'package:on_audio_query/on_audio_query.dart';
import 'package:provider/provider.dart';
import '../services/audio_provider.dart';
import '../theme/app_colors.dart';
import '../../features/home/edit_tags_dialog.dart';
import '../../features/home/online_metadata_screen.dart';

class SongListTile extends StatelessWidget {
  final SongModel song;
  final VoidCallback? onTap;
  final Function(int)? onAddToPlaylist;
  final int? index;
  final Function(LongPressStartDetails, int)? onSelectionStart;
  final Function(LongPressMoveUpdateDetails)? onSelectionUpdate;
  final VoidCallback? onSelectionEnd; // New callback

  const SongListTile({
    super.key,
    required this.song,
    this.onTap,
    this.onAddToPlaylist,
    this.index,
    this.onSelectionStart,
    this.onSelectionUpdate,
    this.onSelectionEnd,
  });

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);
    final isPlaying = audioProvider.currentSong?.id == song.id;

    Widget content = ListTile(
      leading: Container(
        width: 50,
        height: 50,
        decoration: BoxDecoration(
          borderRadius: BorderRadius.circular(8),
          color: AppColors.surfaceLight,
        ),
        child: ClipRRect(
          borderRadius: BorderRadius.circular(8),
          child: QueryArtworkWidget(
            id: song.id,
            type: ArtworkType.AUDIO,
            keepOldArtwork: true,
            format: ArtworkFormat.JPEG,
            size: 100,
            nullArtworkWidget: const Center(
              child: Icon(Icons.music_note, color: AppColors.textSecondary),
            ),
          ),
        ),
      ),
      title: Text(
        song.title,
        maxLines: 1,
        overflow: TextOverflow.ellipsis,
        style: TextStyle(
          color: isPlaying ? AppColors.primary : Colors.white,
          fontWeight: FontWeight.bold,
        ),
      ),
      subtitle: Text(
        song.artist ?? "Bilinmeyen Sanatçı",
        maxLines: 1,
        overflow: TextOverflow.ellipsis,
        style: const TextStyle(color: AppColors.textSecondary),
      ),
      trailing: Row(
        mainAxisSize: MainAxisSize.min,
        children: [
          IconButton(
            icon: Icon(
              audioProvider.isFavorite(song.id)
                  ? Icons.favorite
                  : Icons.favorite_border,
              color: audioProvider.isFavorite(song.id)
                  ? AppColors.primary
                  : AppColors.textSecondary,
              size: 20,
            ),
            onPressed: () {
              audioProvider.toggleFavorite(song.id);
            },
          ),
          PopupMenuButton<String>(
            icon: const Icon(
              Icons.more_vert,
              color: AppColors.textSecondary,
              size: 20,
            ),
            onSelected: (value) {
              if (value == 'search_online') {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) => OnlineMetadataScreen(
                      query: "${song.title} ${song.artist ?? ''}",
                      filePath: song.data,
                    ),
                  ),
                );
              } else if (value == 'edit_offline') {
                showDialog(
                  context: context,
                  builder: (context) => EditTagsDialog(song: song),
                );
              } else if (value == 'add_to_playlist') {
                if (onAddToPlaylist != null) {
                  onAddToPlaylist!(song.id);
                }
              }
            },
            itemBuilder: (context) => [
              const PopupMenuItem(
                value: 'add_to_playlist',
                child: Row(
                  children: [
                    Icon(Icons.playlist_add, color: AppColors.primary),
                    SizedBox(width: 8),
                    Text("Çalma Listesine Ekle"),
                  ],
                ),
              ),
              const PopupMenuItem(
                value: 'edit_offline',
                child: Row(
                  children: [
                    Icon(Icons.edit, color: AppColors.primary),
                    SizedBox(width: 8),
                    Text("Etiketleri Düzenle"),
                  ],
                ),
              ),
              const PopupMenuItem(
                value: 'search_online',
                child: Row(
                  children: [
                    Icon(Icons.public, color: AppColors.primary),
                    SizedBox(width: 8),
                    Text("İnternette Ara"),
                  ],
                ),
              ),
            ],
          ),
        ],
      ),
      onTap: onTap ?? () => audioProvider.playSong(song),
    );

    if (audioProvider.isSelectionMode) {
      content = Container(
        margin: const EdgeInsets.only(bottom: 8),
        child: CheckboxListTile(
          value: audioProvider.selectedSongIds.contains(song.id),
          activeColor: AppColors.primary,
          onChanged: (value) => audioProvider.toggleSelection(song.id),
          title: Text(
            song.title,
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(color: Colors.white),
          ),
          subtitle: Text(
            song.artist ?? "Bilinmeyen Sanatçı",
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(color: AppColors.textSecondary),
          ),
          contentPadding: const EdgeInsets.symmetric(horizontal: 16),
        ),
      );
    }

    return GestureDetector(
      onLongPressStart: (details) {
        if (onSelectionStart != null && index != null) {
          onSelectionStart!(details, index!);
        } else {
          audioProvider.toggleSelectionMode();
          audioProvider.toggleSelection(song.id);
        }
      },
      onLongPressMoveUpdate: onSelectionUpdate,
      onLongPressUp: onSelectionEnd,
      onLongPressEnd: (_) {
        if (onSelectionEnd != null) onSelectionEnd!();
      },
      child: content,
    );
  }
}



=========================================
FILE: lib\core\widgets\splash_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../services/audio_provider.dart';
import '../theme/app_colors.dart';
import '../../features/home/home_screen.dart';
import 'gradient_background.dart';

class SplashScreen extends StatefulWidget {
  const SplashScreen({super.key});

  @override
  State<SplashScreen> createState() => _SplashScreenState();
}

class _SplashScreenState extends State<SplashScreen>
    with SingleTickerProviderStateMixin {
  late AnimationController _controller;
  late Animation<double> _opacityAnimation;
  late Animation<double> _scaleAnimation;

  @override
  void initState() {
    super.initState();
    debugPrint("DEBUG: SplashScreen: initState called.");
    _controller = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 2),
    );

    _opacityAnimation = Tween<double>(begin: 0.0, end: 1.0).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const Interval(0.0, 0.6, curve: Curves.easeIn),
      ),
    );

    _scaleAnimation = Tween<double>(begin: 0.8, end: 1.0).animate(
      CurvedAnimation(
        parent: _controller,
        curve: const Interval(0.0, 0.6, curve: Curves.easeOutBack),
      ),
    );

    _controller.forward();
    _navigateToHome();
  }

  _navigateToHome() async {
    debugPrint("DEBUG: SplashScreen: _navigateToHome started.");
    // 1. Minimum bekleme süresi
    await Future.delayed(const Duration(seconds: 3));

    // 2. JustAudioBackground is already initialized in main.dart

    // 3. AudioProvider'ın yüklenmesini bekle
    if (mounted) {
      debugPrint("DEBUG: SplashScreen: Checking AudioProvider...");
      try {
        final audioProvider = Provider.of<AudioProvider>(
          context,
          listen: false,
        );

        debugPrint("DEBUG: SplashScreen: Requesting permissions...");
        await audioProvider.checkAndRequestPermissions();

        debugPrint("DEBUG: SplashScreen: Initializing AudioProvider...");
        await audioProvider.initialize();

        if (audioProvider.isLoading) {
          debugPrint(
            "DEBUG: SplashScreen: Waiting for AudioProvider to finish loading (max 10s)...",
          );
          final startTime = DateTime.now();
          await Future.doWhile(() async {
            await Future.delayed(const Duration(milliseconds: 200));
            final stillLoading = audioProvider.isLoading;
            final elapsed = DateTime.now().difference(startTime).inSeconds;
            if (elapsed >= 10) {
              debugPrint(
                "DEBUG: SplashScreen: Loading timed out. Proceeding...",
              );
              return false;
            }
            return stillLoading && mounted;
          });
        }
      } catch (e) {
        debugPrint("DEBUG: SplashScreen: FATAL ERROR in _navigateToHome: $e");
      }
    }

    // 3. Ana ekrana yumuşak bir geçiş yap
    if (mounted) {
      debugPrint("DEBUG: SplashScreen: Navigating to HomeScreen...");
      Navigator.pushReplacement(
        context,
        PageRouteBuilder(
          pageBuilder: (_, __, ___) => HomeScreen(),
          transitionsBuilder: (_, animation, __, child) {
            return FadeTransition(opacity: animation, child: child);
          },
          transitionDuration: const Duration(milliseconds: 800),
        ),
      );
    }
  }

  @override
  void dispose() {
    debugPrint("DEBUG: SplashScreen: dispose called.");
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    debugPrint("DEBUG: SplashScreen: build called.");
    return Scaffold(
      body: GradientBackground(
        child: Center(
          child: AnimatedBuilder(
            animation: _controller,
            builder: (context, child) {
              return Opacity(
                opacity: _opacityAnimation.value,
                child: Transform.scale(
                  scale: _scaleAnimation.value,
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    children: [
                      // Temporarily using FlutterLogo to avoid SVG issues
                      const FlutterLogo(size: 120),
                      const SizedBox(height: 24),
                      const Text(
                        "Müzik Çalar",
                        style: TextStyle(
                          color: Colors.white,
                          fontSize: 32,
                          fontWeight: FontWeight.bold,
                          letterSpacing: 1.2,
                        ),
                      ),
                      const SizedBox(height: 48),
                      const CircularProgressIndicator(color: AppColors.primary),
                    ],
                  ),
                ),
              );
            },
          ),
        ),
      ),
    );
  }
}



=========================================
FILE: lib\features\album\album_detail_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:on_audio_query/on_audio_query.dart';
import 'package:provider/provider.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';
import '../../core/widgets/song_list_tile.dart';
import '../player/mini_player.dart';
import '../playlist/playlist_picker.dart';
import '../../core/mixins/auto_scroll_mixin.dart';

class AlbumDetailScreen extends StatefulWidget {
  final AlbumModel album;

  const AlbumDetailScreen({super.key, required this.album});

  @override
  State<AlbumDetailScreen> createState() => _AlbumDetailScreenState();
}

class _AlbumDetailScreenState extends State<AlbumDetailScreen>
    with AutoScrollMixin<AlbumDetailScreen> {
  final ScrollController _scrollController = ScrollController();
  final GlobalKey _scrollViewKey = GlobalKey();
  List<SongModel> _currentSongs = [];

  @override
  ScrollController get scrollController => _scrollController;

  @override
  int get itemCount => _currentSongs.length;

  // Header 300 + buttons (approx 80) = 380
  @override
  double get contentHeaderHeight => 380.0;

  @override
  void onSelectionRangeUpdate(int start, int end) {
    Provider.of<AudioProvider>(
      context,
      listen: false,
    ).selectRange(start, end, sourceList: _currentSongs);
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);
    _currentSongs = audioProvider.getSongsFromAlbum(widget.album.id);

    return Scaffold(
      bottomNavigationBar: audioProvider.isSelectionMode
          ? Container(
              color: AppColors.primary,
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              child: Row(
                children: [
                  Text(
                    "${audioProvider.selectedSongIds.length} Seçildi",
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                  const Spacer(),
                  IconButton(
                    icon: const Icon(Icons.delete, color: Colors.white),
                    onPressed: () async {
                      final confirm = await showDialog<bool>(
                        context: context,
                        builder: (context) => AlertDialog(
                          backgroundColor: AppColors.surface,
                          title: const Text(
                            'Sil',
                            style: TextStyle(color: Colors.white),
                          ),
                          content: const Text(
                            'Seçili şarkıları silmek istediğinize emin misiniz?',
                            style: TextStyle(color: Colors.white),
                          ),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(context, false),
                              child: const Text('Hayır'),
                            ),
                            TextButton(
                              onPressed: () => Navigator.pop(context, true),
                              child: const Text('Evet'),
                            ),
                          ],
                        ),
                      );

                      if (confirm == true) {
                        await audioProvider.deleteSelectedSongs();
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text("Şarkılar silindi")),
                          );
                        }
                      }
                    },
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => audioProvider.toggleSelectionMode(),
                  ),
                ],
              ),
            )
          : null,
      body: Column(
        children: [
          Expanded(
            child: CustomScrollView(
              key: _scrollViewKey,
              controller: _scrollController,
              slivers: [
                SliverAppBar(
                  expandedHeight: 300.0,
                  pinned: true,
                  backgroundColor: AppColors.background,
                  actions: [
                    IconButton(
                      icon: const Icon(
                        Icons.auto_awesome,
                        color: AppColors.primary,
                      ),
                      tooltip: "Bu albümü çalma listesi yap",
                      onPressed: () async {
                        await audioProvider.createSmartPlaylistFromAlbum(
                          widget.album,
                        );
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text(
                                "${widget.album.album} albümü çalma listelerine eklendi!",
                              ),
                            ),
                          );
                        }
                      },
                    ),
                  ],
                  flexibleSpace: FlexibleSpaceBar(
                    title: Text(
                      widget.album.album,
                      style: const TextStyle(color: Colors.white),
                    ),
                    background: QueryArtworkWidget(
                      id: widget.album.id,
                      type: ArtworkType.ALBUM,
                      artworkFit: BoxFit.cover,
                      nullArtworkWidget: Container(
                        color: AppColors.surfaceLight,
                        child: const Center(
                          child: Icon(
                            Icons.album,
                            size: 80,
                            color: AppColors.textSecondary,
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
                SliverToBoxAdapter(
                  child: Padding(
                    padding: const EdgeInsets.all(16.0),
                    child: Row(
                      children: [
                        Expanded(
                          child: ElevatedButton.icon(
                            onPressed: () {
                              audioProvider.playSongList(
                                _currentSongs,
                                shuffle: false,
                              );
                            },
                            icon: const Icon(Icons.play_arrow),
                            label: const Text("Oynat"),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: AppColors.surfaceLight,
                              foregroundColor: Colors.white,
                              padding: const EdgeInsets.symmetric(vertical: 12),
                            ),
                          ),
                        ),
                        const SizedBox(width: 16),
                        Expanded(
                          child: ElevatedButton.icon(
                            onPressed: () {
                              audioProvider.playSongList(
                                _currentSongs,
                                shuffle: true,
                              );
                            },
                            icon: const Icon(Icons.shuffle),
                            label: const Text("Karıştır"),
                            style: ElevatedButton.styleFrom(
                              backgroundColor: AppColors.primary,
                              foregroundColor: Colors.white,
                              padding: const EdgeInsets.symmetric(vertical: 12),
                            ),
                          ),
                        ),
                      ],
                    ),
                  ),
                ),
                SliverList(
                  delegate: SliverChildBuilderDelegate((context, index) {
                    final song = _currentSongs[index];
                    return SongListTile(
                      song: song,
                      index: index,
                      onSelectionStart: (details, idx) {
                        audioProvider.toggleSelectionMode();
                        dragStartIndex = idx;
                        audioProvider.setDraggingSelection(true);
                        audioProvider.toggleSelection(song.id);
                      },
                      onSelectionUpdate: (details) {
                        if (dragStartIndex == null) return;
                        final RenderBox? box =
                            _scrollViewKey.currentContext?.findRenderObject()
                                as RenderBox?;
                        if (box != null) {
                          handleDragUpdate(
                            box.globalToLocal(details.globalPosition),
                            box.size.height,
                          );
                        }
                      },
                      onSelectionEnd: handleDragEnd,
                      onAddToPlaylist: (id) => showPlaylistPicker(
                        context,
                        audioProvider,
                        songId: id,
                      ),
                    );
                  }, childCount: _currentSongs.length),
                ),
              ],
            ),
          ),
          if (audioProvider.currentSong != null) const MiniPlayer(),
        ],
      ),
    );
  }
}



=========================================
FILE: lib\features\equalizer\equalizer_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:equalizer_flutter/equalizer_flutter.dart';
import 'package:provider/provider.dart';
import 'dart:io';
import '../../core/services/audio_provider.dart';

class EqualizerScreen extends StatefulWidget {
  const EqualizerScreen({super.key});

  @override
  State<EqualizerScreen> createState() => _EqualizerScreenState();
}

class _EqualizerScreenState extends State<EqualizerScreen> {
  bool _enabled = false;
  List<int> _bandLevels = [];
  List<int> _centerFreqs = [];
  int _minBandLevel = 0;
  int _maxBandLevel = 0;
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _initEqualizer();
  }

  Future<void> _initEqualizer() async {
    try {
      if (Platform.isAndroid) {
        final audioProvider = Provider.of<AudioProvider>(
          context,
          listen: false,
        );
        final sessionId = audioProvider.audioSessionId;
        if (sessionId != null) {
          await EqualizerFlutter.init(sessionId);
        } else {
          // If no session, we can't init equalizer
          // This prevents the NPE on getBandLevelRange
          if (mounted) {
            setState(() {
              _isLoading = false;
            });
          }
          return;
        }
      }

      final bandLevels = await EqualizerFlutter.getBandLevelRange();
      final centerFreqs = await EqualizerFlutter.getCenterBandFreqs();

      setState(() {
        _enabled = true; // Assume enabled as we enable it on playback
        _minBandLevel = bandLevels[0];
        _maxBandLevel = bandLevels[1];
        _centerFreqs = centerFreqs;
        _bandLevels = List.generate(
          centerFreqs.length,
          (index) => 0,
        ); // Placeholder, normally fetch current
        _isLoading = false;
      });

      // Fetch initial levels
      for (int i = 0; i < _centerFreqs.length; i++) {
        final level = await EqualizerFlutter.getBandLevel(i);
        setState(() {
          _bandLevels[i] = level;
        });
      }
    } catch (e) {
      debugPrint("Error initializing equalizer UI: $e");
      if (mounted) {
        setState(() {
          _isLoading = false;
        });
      }
    }
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Equalizer'),
        backgroundColor: Colors.transparent,
        elevation: 0,
        actions: [
          Switch(
            value: _enabled,
            onChanged: (value) async {
              try {
                await EqualizerFlutter.setEnabled(value);
                setState(() {
                  _enabled = value;
                });
              } catch (e) {
                debugPrint("Error setting enabled: $e");
              }
            },
          ),
        ],
      ),
      extendBodyBehindAppBar: true,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Theme.of(context).primaryColor.withValues(alpha: 0.8),
              Theme.of(context).scaffoldBackgroundColor,
            ],
          ),
        ),
        child: _isLoading
            ? const Center(child: CircularProgressIndicator())
            : _centerFreqs.isEmpty
            ? const Center(
                child: Text(
                  "Play a song to enable Equalizer",
                  style: TextStyle(color: Colors.white),
                ),
              )
            : Padding(
                padding: const EdgeInsets.all(16.0),
                child: Column(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    Expanded(
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                        children: List.generate(_centerFreqs.length, (index) {
                          return Column(
                            mainAxisAlignment: MainAxisAlignment.center,
                            children: [
                              Expanded(
                                child: RotatedBox(
                                  quarterTurns: 3,
                                  child: SliderTheme(
                                    data: SliderTheme.of(context).copyWith(
                                      trackHeight: 4,
                                      thumbShape: const RoundSliderThumbShape(
                                        enabledThumbRadius: 8,
                                      ),
                                      overlayShape:
                                          const RoundSliderOverlayShape(
                                            overlayRadius: 16,
                                          ),
                                    ),
                                    child: Slider(
                                      min: _minBandLevel.toDouble(),
                                      max: _maxBandLevel.toDouble(),
                                      value: _bandLevels[index].toDouble(),
                                      onChanged: (value) async {
                                        setState(() {
                                          _bandLevels[index] = value.toInt();
                                        });
                                        await EqualizerFlutter.setBandLevel(
                                          index,
                                          value.toInt(),
                                        );
                                      },
                                    ),
                                  ),
                                ),
                              ),
                              const SizedBox(height: 8),
                              Text(
                                '${_centerFreqs[index] ~/ 1000} Hz',
                                style: const TextStyle(fontSize: 12),
                              ),
                              Text(
                                '${_bandLevels[index]} dB',
                                style: const TextStyle(
                                  fontSize: 10,
                                  color: Colors.grey,
                                ),
                              ),
                            ],
                          );
                        }),
                      ),
                    ),
                    const SizedBox(height: 50),
                  ],
                ),
              ),
      ),
    );
  }
}



=========================================
FILE: lib\features\home\edit_tags_dialog.dart
=========================================
import 'package:flutter/material.dart';
import 'package:on_audio_query/on_audio_query.dart';
import 'package:provider/provider.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';

class EditTagsDialog extends StatefulWidget {
  final SongModel song;

  const EditTagsDialog({super.key, required this.song});

  @override
  State<EditTagsDialog> createState() => _EditTagsDialogState();
}

class _EditTagsDialogState extends State<EditTagsDialog> {
  late TextEditingController _titleController;
  late TextEditingController _artistController;
  late TextEditingController _albumController;
  late TextEditingController _genreController;

  @override
  void initState() {
    super.initState();
    _titleController = TextEditingController(text: widget.song.title);
    _artistController = TextEditingController(text: widget.song.artist ?? "");
    _albumController = TextEditingController(text: widget.song.album ?? "");
    _genreController = TextEditingController(text: widget.song.genre ?? "");
  }

  @override
  void dispose() {
    _titleController.dispose();
    _artistController.dispose();
    _albumController.dispose();
    _genreController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      backgroundColor: AppColors.surface,
      title: const Text(
        "Etiketleri Düzenle",
        style: TextStyle(color: Colors.white),
      ),
      content: SingleChildScrollView(
        child: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildTextField(_titleController, "Başlık"),
            _buildTextField(_artistController, "Sanatçı"),
            _buildTextField(_albumController, "Albüm"),
            _buildTextField(_genreController, "Tür"),
          ],
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text(
            "İptal",
            style: TextStyle(color: AppColors.textSecondary),
          ),
        ),
        ElevatedButton(
          onPressed: () async {
            final provider = Provider.of<AudioProvider>(context, listen: false);
            final success = await provider.updateSongTags(
              song: widget.song,
              title: _titleController.text,
              artist: _artistController.text,
              album: _albumController.text,
              genre: _genreController.text,
            );

            if (!mounted) return;
            Navigator.pop(context);
            ScaffoldMessenger.of(context).showSnackBar(
              SnackBar(
                content: Text(
                  success
                      ? "Etiketler başarıyla güncellendi"
                      : "Güncelleme sırasında hata oluştu",
                ),
              ),
            );
          },
          style: ElevatedButton.styleFrom(
            backgroundColor: AppColors.primary,
            foregroundColor: Colors.white,
          ),
          child: const Text("Kaydet"),
        ),
      ],
    );
  }

  Widget _buildTextField(TextEditingController controller, String label) {
    return Padding(
      padding: const EdgeInsets.only(bottom: 12.0),
      child: TextField(
        controller: controller,
        style: const TextStyle(color: Colors.white),
        decoration: InputDecoration(
          labelText: label,
          labelStyle: const TextStyle(color: AppColors.textSecondary),
          enabledBorder: const UnderlineInputBorder(
            borderSide: BorderSide(color: AppColors.textSecondary),
          ),
          focusedBorder: const UnderlineInputBorder(
            borderSide: BorderSide(color: AppColors.primary),
          ),
        ),
      ),
    );
  }
}



=========================================
FILE: lib\features\home\home_screen.dart
=========================================
import 'package:flutter/material.dart';
// Add this
import 'package:provider/provider.dart';
import 'package:on_audio_query/on_audio_query.dart';
import '../../core/services/audio_provider.dart';
import '../../core/mixins/auto_scroll_mixin.dart';
import '../../core/theme/app_colors.dart';
import '../../core/widgets/gradient_background.dart';
import '../player/mini_player.dart';
import '../settings/settings_screen.dart';
import '../settings/language_dialog.dart';
import '../equalizer/equalizer_screen.dart';
import 'tabs/album_tab.dart';
import '../playlist/playlist_tab.dart';
import 'tabs/genre_tab.dart';
import 'tabs/folder_tab.dart';
import 'tabs/favorites_tab.dart';
import 'tabs/artist_tab.dart';
import 'search_screen.dart';
import '../settings/sleep_timer_dialog.dart';
import '../../core/widgets/song_list_tile.dart';
import '../playlist/playlist_picker.dart';

class HomeScreen extends StatefulWidget {
  const HomeScreen({super.key});

  @override
  State<HomeScreen> createState() => _HomeScreenState();
}

class _HomeScreenState extends State<HomeScreen>
    with AutoScrollMixin<HomeScreen> {
  final GlobalKey<ScaffoldState> _scaffoldKey = GlobalKey<ScaffoldState>();
  final ScrollController _scrollController = ScrollController();

  @override
  ScrollController get scrollController => _scrollController;

  @override
  int get itemCount =>
      Provider.of<AudioProvider>(context, listen: false).songs.length;

  @override
  void onSelectionRangeUpdate(int start, int end) {
    Provider.of<AudioProvider>(context, listen: false).selectRange(
      start,
      end,
      sourceList: Provider.of<AudioProvider>(context, listen: false).songs,
    );
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    // 1. Listen nicely to selection mode changes for PopScope
    final isSelectionMode = context.select<AudioProvider, bool>(
      (p) => p.isSelectionMode,
    );
    final audioProviderStatic = Provider.of<AudioProvider>(
      context,
      listen: false,
    );

    return PopScope(
      canPop: !isSelectionMode,
      onPopInvokedWithResult: (didPop, result) async {
        if (didPop) return;
        if (isSelectionMode) {
          audioProviderStatic.toggleSelectionMode();
        }
      },
      child: Scaffold(
        key: _scaffoldKey,
        drawer: Drawer(
          backgroundColor: AppColors.background,
          child: ListView(
            padding: EdgeInsets.zero,
            children: [
              const DrawerHeader(
                decoration: BoxDecoration(color: AppColors.surface),
                child: Center(
                  child: Text(
                    'Modern Müzik Çalar',
                    style: TextStyle(
                      color: Colors.white,
                      fontSize: 24,
                      fontWeight: FontWeight.bold,
                    ),
                  ),
                ),
              ),
              ListTile(
                leading: const Icon(Icons.graphic_eq, color: Colors.white),
                title: const Text(
                  'Ekolayzer',
                  style: TextStyle(color: Colors.white),
                ),
                onTap: () {
                  Navigator.pop(context);
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) => const EqualizerScreen(),
                    ),
                  );
                },
              ),
              ListTile(
                leading: const Icon(Icons.image, color: Colors.white),
                title: const Text(
                  'Arkaplan / Tema',
                  style: TextStyle(color: Colors.white),
                ),
                onTap: () {
                  Navigator.pop(context);
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) => const SettingsScreen(),
                    ),
                  );
                },
              ),
              ListTile(
                leading: const Icon(Icons.language, color: Colors.white),
                title: const Text('Dil', style: TextStyle(color: Colors.white)),
                onTap: () {
                  Navigator.pop(context);
                  showDialog(
                    context: context,
                    builder: (context) => const LanguageDialog(),
                  );
                },
              ),
              // Use Selector for Sleep Timer update
              Selector<AudioProvider, String?>(
                selector: (_, p) => p.isSleepTimerActive
                    ? "${p.sleepTimerRemaining?.inMinutes}:${(p.sleepTimerRemaining?.inSeconds ?? 0) % 60}"
                    : null,
                builder: (context, timeStr, child) {
                  return ListTile(
                    leading: const Icon(Icons.timer, color: Colors.white),
                    title: const Text(
                      'Uyku Zamanlayıcısı',
                      style: TextStyle(color: Colors.white),
                    ),
                    subtitle: timeStr != null
                        ? Text(
                            timeStr,
                            style: const TextStyle(color: AppColors.primary),
                          )
                        : null,
                    onTap: () {
                      Navigator.pop(context);
                      showDialog(
                        context: context,
                        builder: (context) => const SleepTimerDialog(),
                      );
                    },
                  );
                },
              ),
            ],
          ),
        ),
        body: GradientBackground(
          child: SafeArea(
            bottom: false,
            child: DefaultTabController(
              length: 7,
              child: Column(
                crossAxisAlignment: CrossAxisAlignment.start,
                children: [
                  // 1. Top Bar / Tabs
                  Padding(
                    padding: const EdgeInsets.symmetric(horizontal: 8.0),
                    child: Row(
                      mainAxisAlignment: MainAxisAlignment.spaceBetween,
                      children: [
                        IconButton(
                          icon: const Icon(Icons.menu, color: Colors.white),
                          onPressed: () {
                            _scaffoldKey.currentState?.openDrawer();
                          },
                        ),
                        Expanded(
                          child: TabBar(
                            isScrollable: true,
                            dividerColor: Colors.transparent,
                            indicatorColor: Colors.white,
                            indicatorSize: TabBarIndicatorSize.label,
                            labelColor: Colors.white,
                            unselectedLabelColor: AppColors.textSecondary,
                            labelStyle: const TextStyle(
                              fontSize: 16,
                              fontWeight: FontWeight.bold,
                            ),
                            tabs: const [
                              Tab(text: "Şarkılar"),
                              Tab(text: "Favoriler"),
                              Tab(text: "Çalma Listeleri"),
                              Tab(text: "Klasörler"),
                              Tab(text: "Albüm"),
                              Tab(text: "Etiketler"),
                              Tab(text: "Sanatçılar"),
                            ],
                          ),
                        ),
                        IconButton(
                          icon: const Icon(Icons.search, color: Colors.white),
                          onPressed: () {
                            Navigator.push(
                              context,
                              MaterialPageRoute(
                                builder: (context) => const SearchScreen(),
                              ),
                            );
                          },
                        ),
                      ],
                    ),
                  ),
                  // 2. Main Content Area (Scoped Consumer)
                  Expanded(
                    child: Consumer<AudioProvider>(
                      builder: (context, audioProvider, child) {
                        if (audioProvider.isLoading) {
                          return const Center(
                            child: CircularProgressIndicator(
                              color: AppColors.primary,
                            ),
                          );
                        }
                        if (!audioProvider.hasPermission) {
                          return Center(
                            child: ElevatedButton(
                              onPressed: () =>
                                  audioProvider.checkAndRequestPermissions(),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: AppColors.primary,
                                foregroundColor: Colors.white,
                              ),
                              child: const Text('İzin Ver'),
                            ),
                          );
                        }
                        return Column(
                          children: [
                            // Song Count & Stats
                            Padding(
                              padding: const EdgeInsets.fromLTRB(
                                20,
                                10,
                                20,
                                10,
                              ),
                              child: Row(
                                children: [
                                  Text(
                                    "${audioProvider.songs.length} Şarkı",
                                    style: const TextStyle(
                                      color: Colors.white,
                                      fontSize: 14,
                                      fontWeight: FontWeight.w500,
                                    ),
                                  ),
                                  const Text(
                                    " (Taranıyor...)",
                                    style: TextStyle(
                                      color: AppColors.textSecondary,
                                      fontSize: 12,
                                    ),
                                  ),
                                  const Spacer(),
                                  IconButton(
                                    icon: const Icon(
                                      Icons.sort,
                                      color: Colors.white,
                                    ),
                                    onPressed: () => _showSortDialog(context),
                                  ),
                                  IconButton(
                                    icon: const Icon(
                                      Icons.check_box_outlined,
                                      color: Colors.white,
                                    ),
                                    onPressed: () {
                                      audioProvider.toggleSelectionMode();
                                    },
                                  ),
                                ],
                              ),
                            ),
                            // Selection Action Bar
                            if (audioProvider.isSelectionMode)
                              Container(
                                color: AppColors.primary,
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 16,
                                  vertical: 8,
                                ),
                                child: Row(
                                  children: [
                                    Text(
                                      "${audioProvider.selectedSongIds.length} Seçildi",
                                      style: const TextStyle(
                                        color: Colors.white,
                                        fontWeight: FontWeight.bold,
                                      ),
                                    ),
                                    const Spacer(),
                                    IconButton(
                                      icon: const Icon(
                                        Icons.delete,
                                        color: Colors.white,
                                      ),
                                      onPressed: () async {
                                        final confirm = await showDialog<bool>(
                                          context: context,
                                          builder: (context) => AlertDialog(
                                            backgroundColor: AppColors.surface,
                                            title: const Text(
                                              'Sil',
                                              style: TextStyle(
                                                color: Colors.white,
                                              ),
                                            ),
                                            content: const Text(
                                              'Seçili şarkıları silmek istediğinize emin misiniz?',
                                              style: TextStyle(
                                                color: Colors.white,
                                              ),
                                            ),
                                            actions: [
                                              TextButton(
                                                onPressed: () => Navigator.pop(
                                                  context,
                                                  false,
                                                ),
                                                child: const Text('Hayır'),
                                              ),
                                              TextButton(
                                                onPressed: () => Navigator.pop(
                                                  context,
                                                  true,
                                                ),
                                                child: const Text('Evet'),
                                              ),
                                            ],
                                          ),
                                        );
                                        if (confirm == true) {
                                          await audioProvider
                                              .deleteSelectedSongs();
                                          if (context.mounted) {
                                            ScaffoldMessenger.of(
                                              context,
                                            ).showSnackBar(
                                              const SnackBar(
                                                content: Text(
                                                  "Şarkılar silindi",
                                                ),
                                              ),
                                            );
                                          }
                                        }
                                      },
                                    ),
                                    IconButton(
                                      icon: const Icon(
                                        Icons.playlist_add,
                                        color: Colors.white,
                                      ),
                                      onPressed: () {
                                        _showPlaylistPicker(
                                          context,
                                          audioProvider,
                                        );
                                      },
                                    ),
                                    IconButton(
                                      icon: const Icon(
                                        Icons.close,
                                        color: Colors.white,
                                      ),
                                      onPressed: () =>
                                          audioProvider.toggleSelectionMode(),
                                    ),
                                  ],
                                ),
                              ),
                            // Action Buttons
                            Padding(
                              padding: const EdgeInsets.symmetric(
                                horizontal: 16,
                              ),
                              child: Row(
                                children: [
                                  Expanded(
                                    child: ElevatedButton.icon(
                                      onPressed: () {
                                        if (!audioProvider.isShuffleMode) {
                                          audioProvider.toggleShuffle();
                                        }
                                        audioProvider.playNext();
                                      },
                                      icon: const Icon(
                                        Icons.shuffle,
                                        color: AppColors.heavyOrange,
                                      ),
                                      label: const Text("Karıştır"),
                                      style: ElevatedButton.styleFrom(
                                        backgroundColor: Colors.white
                                            .withValues(alpha: 0.05),
                                        foregroundColor: Colors.white,
                                        shape: RoundedRectangleBorder(
                                          borderRadius: BorderRadius.circular(
                                            20,
                                          ),
                                        ),
                                        padding: const EdgeInsets.symmetric(
                                          vertical: 12,
                                        ),
                                      ),
                                    ),
                                  ),
                                  const SizedBox(width: 12),
                                  Expanded(
                                    child: ElevatedButton.icon(
                                      onPressed: () {
                                        if (audioProvider.songs.isNotEmpty) {
                                          audioProvider.playSong(
                                            audioProvider.songs.first,
                                          );
                                        }
                                      },
                                      icon: const Icon(
                                        Icons.play_arrow,
                                        color: AppColors.heavyOrange,
                                      ),
                                      label: const Text("Oynat"),
                                      style: ElevatedButton.styleFrom(
                                        backgroundColor: Colors.white
                                            .withValues(alpha: 0.05),
                                        foregroundColor: Colors.white,
                                        shape: RoundedRectangleBorder(
                                          borderRadius: BorderRadius.circular(
                                            20,
                                          ),
                                        ),
                                        padding: const EdgeInsets.symmetric(
                                          vertical: 12,
                                        ),
                                      ),
                                    ),
                                  ),
                                ],
                              ),
                            ),
                            const SizedBox(height: 10),
                            // Song List Tabs
                            Expanded(
                              child: TabBarView(
                                children: [
                                  _buildSongList(context, audioProvider),
                                  const FavoritesTab(),
                                  const PlaylistTab(),
                                  const FolderTab(),
                                  AlbumTab(audioProvider: audioProvider),
                                  GenreTab(audioProvider: audioProvider),
                                  ArtistTab(audioProvider: audioProvider),
                                ],
                              ),
                            ),
                          ],
                        );
                      },
                    ),
                  ),
                  // 3. Mini Player (Scoped Selector)
                  Selector<AudioProvider, bool>(
                    selector: (_, p) => p.currentSong != null,
                    builder: (context, hasSong, child) {
                      return hasSong ? const MiniPlayer() : const SizedBox();
                    },
                  ),
                ],
              ),
            ),
          ),
        ),
      ),
    );
  }

  final GlobalKey _listKey = GlobalKey(); // Add this key

  Widget _buildSongList(BuildContext context, AudioProvider audioProvider) {
    if (audioProvider.songs.isEmpty) {
      return const Center(
        child: Text('Müzik bulunamadı', style: TextStyle(color: Colors.white)),
      );
    }

    return Listener(
      onPointerDown: (details) {
        if (audioProvider.isSelectionMode) {
          handleDragStart(details.localPosition);
          audioProvider.setDraggingSelection(true);
        }
      },
      onPointerMove: (details) {
        if (dragStartIndex != null && audioProvider.isDraggingSelection) {
          final RenderBox? box =
              _listKey.currentContext?.findRenderObject() as RenderBox?;
          if (box != null && box.hasSize) {
            handleDragUpdate(details.localPosition, box.size.height);
          }
        }
      },
      onPointerUp: (_) {
        handleDragEnd();
        audioProvider.setDraggingSelection(false);
      },
      child: RefreshIndicator(
        onRefresh: () async => await audioProvider.checkAndRequestPermissions(),
        child: ListView.builder(
          key: _listKey, // Assign key here
          controller: _scrollController,
          padding: const EdgeInsets.all(16),
          // Sürükleme yaparken listenin kendi kaydırmasını kapatıyoruz
          physics: audioProvider.isDraggingSelection
              ? const NeverScrollableScrollPhysics()
              : const AlwaysScrollableScrollPhysics(),
          itemCount: audioProvider.songs.length,
          itemBuilder: (context, index) {
            final song = audioProvider.songs[index];
            return audioProvider.isSelectionMode
                ? Container(
                    margin: const EdgeInsets.only(bottom: 8),
                    child: CheckboxListTile(
                      value: audioProvider.selectedSongIds.contains(song.id),
                      activeColor: AppColors.primary,
                      onChanged: (value) =>
                          audioProvider.toggleSelection(song.id),
                      title: Text(
                        song.title,
                        style: const TextStyle(color: Colors.white),
                      ),
                      subtitle: Text(
                        song.artist ?? "Bilinmeyen Sanatçı",
                        style: const TextStyle(color: AppColors.textSecondary),
                      ),
                    ),
                  )
                : SongListTile(
                    song: song,
                    index: index,
                    onSelectionStart: (details, idx) {
                      audioProvider.toggleSelectionMode();
                      dragStartIndex = idx;
                      audioProvider.setDraggingSelection(true);
                      audioProvider.toggleSelection(song.id);

                      // Initial position update to ensure sync
                      final RenderBox? box =
                          _listKey.currentContext?.findRenderObject()
                              as RenderBox?;
                      if (box != null) {
                        lastLocalPosition = box.globalToLocal(
                          details.globalPosition,
                        );
                      }
                    },
                    onSelectionUpdate: (details) {
                      if (dragStartIndex == null) return;
                      final RenderBox? box =
                          _listKey.currentContext?.findRenderObject()
                              as RenderBox?;
                      if (box != null && box.hasSize) {
                        handleDragUpdate(
                          box.globalToLocal(details.globalPosition),
                          box.size.height,
                        );
                      }
                    },
                    onSelectionEnd: handleDragEnd,
                    onAddToPlaylist: (id) =>
                        showPlaylistPicker(context, audioProvider, songId: id),
                  );
          },
        ),
      ),
    );
  }

  void _showPlaylistPicker(
    BuildContext context,
    AudioProvider audioProvider, {
    int? songId,
  }) {
    showModalBottomSheet(
      context: context,
      backgroundColor: AppColors.surface,
      builder: (context) => ListView.builder(
        itemCount: audioProvider.playlists.length,
        itemBuilder: (context, index) {
          final playlist = audioProvider.playlists[index];
          return ListTile(
            leading: const Icon(Icons.playlist_play, color: Colors.white),
            title: Text(
              playlist.playlist,
              style: const TextStyle(color: Colors.white),
            ),
            onTap: () async {
              if (songId != null) {
                await audioProvider.addToPlaylist(playlist.id, songId);
              } else {
                await audioProvider.addSelectedToPlaylist(playlist.id);
              }

              if (context.mounted) {
                Navigator.pop(context);
                ScaffoldMessenger.of(context).showSnackBar(
                  SnackBar(
                    content: Text(
                      songId != null
                          ? "Şarkı ${playlist.playlist} listesine eklendi"
                          : "Şarkılar ${playlist.playlist} listesine eklendi",
                    ),
                  ),
                );
              }
            },
          );
        },
      ),
    );
  }

  void _showSortDialog(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context, listen: false);

    showDialog(
      context: context,
      builder: (context) => AlertDialog(
        backgroundColor: AppColors.surface,
        title: const Text('Sırala', style: TextStyle(color: Colors.white)),
        content: Column(
          mainAxisSize: MainAxisSize.min,
          children: [
            _buildSortOption(context, 'İsim (A-Z)', SongSortType.TITLE),
            _buildSortOption(context, 'Sanatçı (A-Z)', SongSortType.ARTIST),
            _buildSortOption(context, 'Albüm (A-Z)', SongSortType.ALBUM),
            _buildSortOption(
              context,
              'Tarih (Yeni > Eski)',
              SongSortType.DATE_ADDED,
            ),
            _buildSortOption(
              context,
              'Süre (Uzun > Kısa)',
              SongSortType.DURATION,
            ),
            const Divider(color: Colors.grey),
            _buildCustomSortOption(
              context,
              'En Çok Dinlenen',
              1,
              audioProvider,
            ),
            _buildCustomSortOption(context, 'En Az Dinlenen', 2, audioProvider),
          ],
        ),
      ),
    );
  }

  Widget _buildSortOption(
    BuildContext context,
    String title,
    SongSortType sortType,
  ) {
    return ListTile(
      title: Text(title, style: const TextStyle(color: Colors.white)),
      onTap: () {
        Provider.of<AudioProvider>(context, listen: false).updateSort(sortType);
        Navigator.pop(context);
      },
    );
  }

  Widget _buildCustomSortOption(
    BuildContext context,
    String title,
    int customType,
    AudioProvider provider,
  ) {
    return ListTile(
      title: Text(title, style: const TextStyle(color: Colors.white)),
      onTap: () {
        provider.updateSort(customType);
        Navigator.pop(context);
      },
    );
  }
}



=========================================
FILE: lib\features\home\online_metadata_screen.dart
=========================================
import 'package:flutter/material.dart';
import '../../core/services/shazam_service.dart';
import '../../core/theme/app_colors.dart';
import '../../core/services/tag_editor_service.dart';

class OnlineMetadataScreen extends StatefulWidget {
  final String query;
  final String? filePath; // If valid, we allow updating this file

  const OnlineMetadataScreen({super.key, required this.query, this.filePath});

  @override
  State<OnlineMetadataScreen> createState() => _OnlineMetadataScreenState();
}

class _OnlineMetadataScreenState extends State<OnlineMetadataScreen> {
  final ShazamService _shazamService = ShazamService();
  final TagEditorService _tagService = TagEditorService();
  List<dynamic> _results = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _search();
  }

  Future<void> _search() async {
    final results = await _shazamService.search(widget.query);
    setState(() {
      _results = results;
      _isLoading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: AppColors.background,
      appBar: AppBar(
        backgroundColor: AppColors.surface,
        title: const Text(
          "İnternet Sonuçları",
          style: TextStyle(color: Colors.white),
        ),
        leading: const BackButton(color: Colors.white),
      ),
      body: _isLoading
          ? const Center(
              child: CircularProgressIndicator(color: AppColors.primary),
            )
          : _results.isEmpty
          ? const Center(
              child: Text(
                "Sonuç bulunamadı",
                style: TextStyle(color: Colors.white),
              ),
            )
          : ListView.builder(
              padding: const EdgeInsets.all(16),
              itemCount: _results.length,
              itemBuilder: (itemContext, index) {
                final item = _results[index];
                final track = item['track'];

                if (track == null) return const SizedBox();

                final title = track['title'] ?? 'Unknown';
                final subtitle = track['subtitle'] ?? 'Unknown';
                final images = track['images'];
                final coverUrl = images != null ? images['coverart'] : null;
                final genres = track['genres'];
                final primaryGenre = genres != null
                    ? genres['primary']
                    : "Bilinmiyor";

                return Card(
                  color: AppColors.surfaceLight,
                  margin: const EdgeInsets.only(bottom: 12),
                  child: ListTile(
                    leading: coverUrl != null
                        ? Image.network(
                            coverUrl,
                            width: 50,
                            height: 50,
                            fit: BoxFit.cover,
                          )
                        : const Icon(Icons.music_note, color: Colors.white),
                    title: Text(
                      title,
                      style: const TextStyle(
                        color: Colors.white,
                        fontWeight: FontWeight.bold,
                      ),
                    ),
                    subtitle: Column(
                      crossAxisAlignment: CrossAxisAlignment.start,
                      children: [
                        Text(
                          subtitle,
                          style: const TextStyle(
                            color: AppColors.textSecondary,
                          ),
                        ),
                        Text(
                          "Tür: $primaryGenre",
                          style: const TextStyle(
                            color: AppColors.primary,
                            fontSize: 12,
                          ),
                        ),
                      ],
                    ),
                    onTap: () async {
                      if (widget.filePath != null) {
                        if (widget.filePath!.startsWith('content://')) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(
                              content: Text(
                                "Bu dosya düzenlenemiyor (Content URI).",
                              ),
                            ),
                          );
                          return;
                        }

                        // Confirm Dialog
                        final confirm = await showDialog<bool>(
                          context: context,
                          builder: (context) => AlertDialog(
                            backgroundColor: AppColors.surface,
                            title: const Text(
                              "Etiketleri Güncelle",
                              style: TextStyle(color: Colors.white),
                            ),
                            content: Text(
                              "Bu şarkının bilgilerini '$title' olarak değiştirmek istiyor musunuz?",
                              style: const TextStyle(color: Colors.white70),
                            ),
                            actions: [
                              TextButton(
                                onPressed: () => Navigator.pop(context, false),
                                child: const Text("İptal"),
                              ),
                              TextButton(
                                onPressed: () => Navigator.pop(context, true),
                                child: const Text("Güncelle"),
                              ),
                            ],
                          ),
                        );

                        if (!mounted) return;

                        if (confirm == true) {
                          setState(() => _isLoading = true);
                          final success = await _tagService.updateTags(
                            filePath: widget.filePath!,
                            title: title,
                            artist: item['track']['subtitle'] ?? 'Unknown',
                            album:
                                item['track']['sections']?[0]['metadata']?[0]['text'], // Helper guess
                            genre: primaryGenre,
                            coverUrl: coverUrl,
                          );
                          if (!mounted) return;
                          setState(() => _isLoading = false);
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text(
                                success
                                    ? "Güncellendi! Listeyi yenileyin."
                                    : "Hata oluştu.",
                              ),
                            ),
                          );
                          if (success) {
                            Navigator.pop(context); // Go back
                          }
                        }
                      } else {
                        ScaffoldMessenger.of(context).showSnackBar(
                          const SnackBar(
                            content: Text("Önizleme modu. Dosya seçilmedi."),
                          ),
                        );
                      }
                    },
                  ),
                );
              },
            ),
    );
  }
}



=========================================
FILE: lib\features\home\search_screen.dart
=========================================
import 'package:flutter/material.dart';
// Add this
import 'package:provider/provider.dart';
import 'package:on_audio_query/on_audio_query.dart';
import '../../core/services/audio_provider.dart';
import '../../core/mixins/auto_scroll_mixin.dart';
import '../../core/theme/app_colors.dart';
import '../../core/widgets/song_list_tile.dart';
import '../player/mini_player.dart';
import '../playlist/playlist_picker.dart';
import 'online_metadata_screen.dart';

class SearchScreen extends StatefulWidget {
  const SearchScreen({super.key});

  @override
  State<SearchScreen> createState() => _SearchScreenState();
}

class _SearchScreenState extends State<SearchScreen>
    with AutoScrollMixin<SearchScreen> {
  String _query = '';
  final TextEditingController _controller = TextEditingController();
  final ScrollController _scrollController = ScrollController();
  List<SongModel> _filteredSongs = [];

  @override
  ScrollController get scrollController => _scrollController;

  @override
  int get itemCount => _filteredSongs.length;

  @override
  void onSelectionRangeUpdate(int start, int end) {
    Provider.of<AudioProvider>(
      context,
      listen: false,
    ).selectRange(start, end, sourceList: _filteredSongs);
  }

  @override
  void dispose() {
    _controller.dispose();
    _scrollController.dispose();
    super.dispose();
  }

  final GlobalKey _listKey = GlobalKey(); // Add this key

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);
    final allSongs = audioProvider.songs;

    // Filter songs based on query
    _filteredSongs = _query.isEmpty
        ? []
        : allSongs.where((song) {
            final titleLower = song.title.toLowerCase();
            final artistLower = (song.artist ?? "").toLowerCase();
            final searchLower = _query.toLowerCase();
            return titleLower.contains(searchLower) ||
                artistLower.contains(searchLower);
          }).toList();

    return Scaffold(
      backgroundColor: AppColors.background,
      bottomNavigationBar: audioProvider.isSelectionMode
          ? Container(
              color: AppColors.primary,
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              child: Row(
                children: [
                  Text(
                    "${audioProvider.selectedSongIds.length} Seçildi",
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                  const Spacer(),
                  IconButton(
                    icon: const Icon(Icons.delete, color: Colors.white),
                    onPressed: () async {
                      final confirm = await showDialog<bool>(
                        context: context,
                        builder: (context) => AlertDialog(
                          backgroundColor: AppColors.surface,
                          title: const Text(
                            'Sil',
                            style: TextStyle(color: Colors.white),
                          ),
                          content: const Text(
                            'Seçili şarkıları silmek istediğinize emin misiniz?',
                            style: TextStyle(color: Colors.white),
                          ),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(context, false),
                              child: const Text('Hayır'),
                            ),
                            TextButton(
                              onPressed: () => Navigator.pop(context, true),
                              child: const Text('Evet'),
                            ),
                          ],
                        ),
                      );

                      if (confirm == true) {
                        await audioProvider.deleteSelectedSongs();
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text("Şarkılar silindi")),
                          );
                        }
                      }
                    },
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => audioProvider.toggleSelectionMode(),
                  ),
                ],
              ),
            )
          : null,
      appBar: AppBar(
        backgroundColor: AppColors.surface,
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () => Navigator.pop(context),
        ),
        title: TextField(
          controller: _controller,
          autofocus: true,
          style: const TextStyle(color: Colors.white),
          cursorColor: AppColors.primary,
          decoration: const InputDecoration(
            hintText: 'Şarkı veya sanatçı ara...',
            hintStyle: TextStyle(color: AppColors.textSecondary),
            border: InputBorder.none,
          ),
          onChanged: (value) {
            setState(() {
              _query = value;
            });
          },
        ),
        actions: [
          if (_query.isNotEmpty)
            IconButton(
              icon: const Icon(Icons.clear, color: Colors.white),
              onPressed: () {
                _controller.clear();
                setState(() {
                  _query = '';
                });
              },
            ),
          IconButton(
            icon: const Icon(Icons.public, color: Colors.white),
            onPressed: () {
              if (_query.isNotEmpty) {
                Navigator.push(
                  context,
                  MaterialPageRoute(
                    builder: (context) => OnlineMetadataScreen(query: _query),
                  ),
                );
              } else {
                ScaffoldMessenger.of(context).showSnackBar(
                  const SnackBar(content: Text("Lütfen bir şeyler yazın")),
                );
              }
            },
          ),
        ],
      ),
      body: Column(
        children: [
          Expanded(
            child: _query.isEmpty
                ? const Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        Icon(
                          Icons.search,
                          size: 64,
                          color: AppColors.textSecondary,
                        ),
                        SizedBox(height: 16),
                        Text(
                          'Aramak için yazmaya başlayın',
                          style: TextStyle(
                            color: AppColors.textSecondary,
                            fontSize: 16,
                          ),
                        ),
                      ],
                    ),
                  )
                : _filteredSongs.isEmpty
                ? const Center(
                    child: Text(
                      'Sonuç bulunamadı',
                      style: TextStyle(color: Colors.white),
                    ),
                  )
                : Listener(
                    onPointerDown: (details) {
                      if (audioProvider.isSelectionMode) {
                        handleDragStart(details.localPosition);
                        audioProvider.setDraggingSelection(true);
                      }
                    },
                    onPointerMove: (details) {
                      if (dragStartIndex != null &&
                          audioProvider.isDraggingSelection) {
                        final RenderBox? box =
                            _listKey.currentContext?.findRenderObject()
                                as RenderBox?;
                        if (box != null && box.hasSize) {
                          handleDragUpdate(
                            details.localPosition,
                            box.size.height,
                          );
                        }
                      }
                    },
                    onPointerUp: (_) {
                      handleDragEnd();
                      audioProvider.setDraggingSelection(false);
                    },
                    onPointerCancel: (_) {
                      handleDragEnd();
                      audioProvider.setDraggingSelection(false);
                    },
                    child: ListView.builder(
                      key: _listKey, // Assign key here
                      controller: _scrollController,
                      padding: const EdgeInsets.all(16),
                      physics: audioProvider.isDraggingSelection
                          ? const NeverScrollableScrollPhysics()
                          : const AlwaysScrollableScrollPhysics(),
                      itemCount: _filteredSongs.length,
                      itemBuilder: (context, index) {
                        final song = _filteredSongs[index];

                        return audioProvider.isSelectionMode
                            ? Container(
                                margin: const EdgeInsets.only(bottom: 8),
                                child: CheckboxListTile(
                                  value: audioProvider.selectedSongIds.contains(
                                    song.id,
                                  ),
                                  activeColor: AppColors.primary,
                                  onChanged: (value) =>
                                      audioProvider.toggleSelection(song.id),
                                  title: Text(
                                    song.title,
                                    style: const TextStyle(color: Colors.white),
                                  ),
                                  subtitle: Text(
                                    song.artist ?? "Bilinmeyen Sanatçı",
                                    style: const TextStyle(
                                      color: AppColors.textSecondary,
                                    ),
                                  ),
                                ),
                              )
                            : SongListTile(
                                song: song,
                                index: index,
                                onSelectionStart: (details, idx) {
                                  audioProvider.toggleSelectionMode();
                                  dragStartIndex = idx;
                                  audioProvider.setDraggingSelection(true);
                                  audioProvider.toggleSelection(song.id);

                                  final RenderBox? box =
                                      _listKey.currentContext
                                              ?.findRenderObject()
                                          as RenderBox?;
                                  if (box != null) {
                                    lastLocalPosition = box.globalToLocal(
                                      details.globalPosition,
                                    );
                                  }
                                },
                                onSelectionUpdate: (details) {
                                  if (dragStartIndex == null) return;
                                  final RenderBox? box =
                                      _listKey.currentContext
                                              ?.findRenderObject()
                                          as RenderBox?;
                                  if (box != null && box.hasSize) {
                                    handleDragUpdate(
                                      box.globalToLocal(details.globalPosition),
                                      box.size.height,
                                    );
                                  }
                                },
                                onSelectionEnd: handleDragEnd,
                                onAddToPlaylist: (id) => showPlaylistPicker(
                                  context,
                                  audioProvider,
                                  songId: id,
                                ),
                              );
                      },
                    ),
                  ),
          ),
          if (audioProvider.currentSong != null) const MiniPlayer(),
        ],
      ),
    );
  }
}



=========================================
FILE: lib\features\home\tabs\album_tab.dart
=========================================
import 'package:flutter/material.dart';
import 'package:on_audio_query/on_audio_query.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/services/audio_provider.dart';
import '../../album/album_detail_screen.dart';

class AlbumTab extends StatelessWidget {
  final AudioProvider audioProvider;

  const AlbumTab({super.key, required this.audioProvider});

  @override
  Widget build(BuildContext context) {
    if (audioProvider.albums.isEmpty) {
      return const Center(
        child: Text("Albüm bulunamadı", style: TextStyle(color: Colors.white)),
      );
    }

    return RefreshIndicator(
      onRefresh: () async {
        await audioProvider.fetchAlbums();
      },
      color: AppColors.primary,
      backgroundColor: AppColors.surface,
      child: GridView.builder(
        padding: const EdgeInsets.all(16),
        physics: const AlwaysScrollableScrollPhysics(),
        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 2,
          crossAxisSpacing: 16,
          mainAxisSpacing: 16,
          childAspectRatio: 0.8,
        ),
        itemCount: audioProvider.albums.length,
        itemBuilder: (context, index) {
          final album = audioProvider.albums[index];
          return InkWell(
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => AlbumDetailScreen(album: album),
                ),
              );
            },
            borderRadius: BorderRadius.circular(16),
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                Expanded(
                  child: Container(
                    decoration: BoxDecoration(
                      borderRadius: BorderRadius.circular(16),
                      color: AppColors.surfaceLight,
                    ),
                    child: ClipRRect(
                      borderRadius: BorderRadius.circular(16),
                      child: QueryArtworkWidget(
                        id: album.id,
                        type: ArtworkType.ALBUM,
                        artworkFit: BoxFit.cover,
                        keepOldArtwork: true,
                        format: ArtworkFormat.JPEG,
                        size: 300, // Medium size for grid
                        nullArtworkWidget: const Center(
                          child: Icon(
                            Icons.album,
                            size: 50,
                            color: AppColors.textSecondary,
                          ),
                        ),
                      ),
                    ),
                  ),
                ),
                const SizedBox(height: 8),
                Text(
                  album.album,
                  maxLines: 1,
                  overflow: TextOverflow.ellipsis,
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                    fontSize: 16,
                  ),
                ),
                Text(
                  "${album.numOfSongs} Şarkı",
                  style: const TextStyle(
                    color: AppColors.textSecondary,
                    fontSize: 12,
                  ),
                ),
              ],
            ),
          );
        },
      ),
    );
  }
}



=========================================
FILE: lib\features\home\tabs\artist_detail_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:on_audio_query/on_audio_query.dart';
import 'package:provider/provider.dart';
import '../../../core/services/audio_provider.dart';
import '../../../core/theme/app_colors.dart';
import '../../player/mini_player.dart';
import '../../../core/mixins/auto_scroll_mixin.dart';
import '../../../core/widgets/song_list_tile.dart';
import '../../playlist/playlist_picker.dart';

class ArtistDetailScreen extends StatefulWidget {
  final ArtistModel artist;

  const ArtistDetailScreen({super.key, required this.artist});

  @override
  State<ArtistDetailScreen> createState() => _ArtistDetailScreenState();
}

class _ArtistDetailScreenState extends State<ArtistDetailScreen>
    with AutoScrollMixin<ArtistDetailScreen> {
  List<SongModel> _songs = [];
  bool _isLoading = true;
  final ScrollController _scrollController = ScrollController();
  final GlobalKey _scrollViewKey = GlobalKey();

  @override
  ScrollController get scrollController => _scrollController;

  @override
  int get itemCount => _songs.length;

  @override
  // Header (200) + Buttons (estimated 80) = 280.0
  @override
  double get contentHeaderHeight => 280.0;

  @override
  void onSelectionRangeUpdate(int start, int end) {
    Provider.of<AudioProvider>(
      context,
      listen: false,
    ).selectRange(start, end, sourceList: _songs);
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);

    return Scaffold(
      bottomNavigationBar: audioProvider.isSelectionMode
          ? Container(
              color: AppColors.primary,
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              child: Row(
                children: [
                  Text(
                    "${audioProvider.selectedSongIds.length} Seçildi",
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                  const Spacer(),
                  IconButton(
                    icon: const Icon(Icons.delete, color: Colors.white),
                    onPressed: () async {
                      final confirm = await showDialog<bool>(
                        context: context,
                        builder: (context) => AlertDialog(
                          backgroundColor: AppColors.surface,
                          title: const Text(
                            'Sil',
                            style: TextStyle(color: Colors.white),
                          ),
                          content: const Text(
                            'Seçili şarkıları silmek istediğinize emin misiniz?',
                            style: TextStyle(color: Colors.white),
                          ),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(context, false),
                              child: const Text('Hayır'),
                            ),
                            TextButton(
                              onPressed: () => Navigator.pop(context, true),
                              child: const Text('Evet'),
                            ),
                          ],
                        ),
                      );

                      if (confirm == true) {
                        await audioProvider.deleteSelectedSongs();
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text("Şarkılar silindi")),
                          );
                        }
                      }
                    },
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => audioProvider.toggleSelectionMode(),
                  ),
                ],
              ),
            )
          : null,
      body: Column(
        children: [
          Expanded(
            child: CustomScrollView(
              key: _scrollViewKey,
              controller: _scrollController,
              slivers: [
                SliverAppBar(
                  expandedHeight: 200.0,
                  pinned: true,
                  backgroundColor: AppColors.background,
                  actions: [
                    IconButton(
                      icon: const Icon(
                        Icons.auto_awesome_motion,
                        color: AppColors.primary,
                      ),
                      tooltip: "Bu sanatçıdan çalma listesi oluştur",
                      onPressed: () async {
                        await audioProvider.createSmartPlaylistFromArtist(
                          widget.artist,
                        );
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text(
                                "${widget.artist.artist} çalma listelerine eklendi!",
                              ),
                            ),
                          );
                        }
                      },
                    ),
                  ],
                  flexibleSpace: FlexibleSpaceBar(
                    title: Text(
                      widget.artist.artist,
                      style: const TextStyle(color: Colors.white),
                    ),
                    background: Container(
                      color: AppColors.surfaceLight,
                      child: const Center(
                        child: Icon(
                          Icons.person,
                          size: 80,
                          color: AppColors.textSecondary,
                        ),
                      ),
                    ),
                  ),
                ),
                if (_isLoading)
                  const SliverFillRemaining(
                    child: Center(
                      child: CircularProgressIndicator(
                        color: AppColors.primary,
                      ),
                    ),
                  )
                else if (_songs.isEmpty)
                  const SliverFillRemaining(
                    child: Center(
                      child: Text(
                        "Şarkı bulunamadı",
                        style: TextStyle(color: Colors.white),
                      ),
                    ),
                  )
                else
                  SliverToBoxAdapter(
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          Expanded(
                            child: ElevatedButton.icon(
                              onPressed: () {
                                audioProvider.playSongList(
                                  _songs,
                                  shuffle: false,
                                );
                              },
                              icon: const Icon(Icons.play_arrow),
                              label: const Text("Oynat"),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: AppColors.surfaceLight,
                                foregroundColor: Colors.white,
                                padding: const EdgeInsets.symmetric(
                                  vertical: 12,
                                ),
                              ),
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: ElevatedButton.icon(
                              onPressed: () {
                                audioProvider.playSongList(
                                  _songs,
                                  shuffle: true,
                                );
                              },
                              icon: const Icon(Icons.shuffle),
                              label: const Text("Karıştır"),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: AppColors.primary,
                                foregroundColor: Colors.white,
                                padding: const EdgeInsets.symmetric(
                                  vertical: 12,
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                SliverList(
                  delegate: SliverChildBuilderDelegate((context, index) {
                    final song = _songs[index];
                    return SongListTile(
                      song: song,
                      index: index,
                      onSelectionStart: (details, idx) {
                        audioProvider.toggleSelectionMode();
                        dragStartIndex = idx;
                        audioProvider.setDraggingSelection(true);
                        audioProvider.toggleSelection(song.id);
                      },
                      onSelectionUpdate: (details) {
                        if (dragStartIndex == null) return;
                        final RenderBox? box =
                            _scrollViewKey.currentContext?.findRenderObject()
                                as RenderBox?;
                        if (box != null) {
                          handleDragUpdate(
                            box.globalToLocal(details.globalPosition),
                            box.size.height,
                          );
                        }
                      },
                      onSelectionEnd: handleDragEnd,
                      onAddToPlaylist: (id) => showPlaylistPicker(
                        context,
                        audioProvider,
                        songId: id,
                      ),
                    );
                  }, childCount: _songs.length),
                ),
              ],
            ),
          ),
          if (audioProvider.currentSong != null) const MiniPlayer(),
        ],
      ),
    );
  }
}



=========================================
FILE: lib\features\home\tabs\artist_tab.dart
=========================================
import 'package:flutter/material.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/services/audio_provider.dart';
import 'artist_detail_screen.dart';

class ArtistTab extends StatelessWidget {
  final AudioProvider audioProvider;

  const ArtistTab({super.key, required this.audioProvider});

  @override
  Widget build(BuildContext context) {
    if (audioProvider.artists.isEmpty) {
      return const Center(
        child: Text(
          "Sanatçı bulunamadı",
          style: TextStyle(color: Colors.white),
        ),
      );
    }

    return RefreshIndicator(
      onRefresh: () async {
        await audioProvider.fetchArtists();
      },
      color: AppColors.primary,
      backgroundColor: AppColors.surface,
      child: GridView.builder(
        padding: const EdgeInsets.all(16),
        physics: const AlwaysScrollableScrollPhysics(),
        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 2,
          crossAxisSpacing: 16,
          mainAxisSpacing: 16,
          childAspectRatio:
              1.0, // Square for artists? Or keeping same 1.5? Let's use 1.0 for variety or better, match Album/Genre. Genre was 1.5. Artists often have photos, but we use defaults. 1.2 might be good.
        ),
        itemCount: audioProvider.artists.length,
        itemBuilder: (context, index) {
          final artist = audioProvider.artists[index];
          return InkWell(
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => ArtistDetailScreen(artist: artist),
                ),
              );
            },
            borderRadius: BorderRadius.circular(16),
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                color: AppColors.surfaceLight,
              ),
              padding: const EdgeInsets.all(12),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Icon(
                    Icons.person,
                    size: 40,
                    color: AppColors.textSecondary,
                  ),
                  const SizedBox(height: 12),
                  Text(
                    artist.artist,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    textAlign: TextAlign.center,
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                  const SizedBox(height: 4),
                  Text(
                    "${artist.numberOfTracks} Şarkı",
                    style: const TextStyle(
                      color: AppColors.textSecondary,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}



=========================================
FILE: lib\features\home\tabs\favorites_tab.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../core/services/audio_provider.dart';
import '../../../core/widgets/song_list_tile.dart';
import '../../playlist/playlist_picker.dart';

class FavoritesTab extends StatelessWidget {
  const FavoritesTab({super.key});

  @override
  Widget build(BuildContext context) {
    return Consumer<AudioProvider>(
      builder: (context, audioProvider, child) {
        final favorites = audioProvider.favoriteSongs;

        if (favorites.isEmpty) {
          return const Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(Icons.favorite_border, size: 64, color: Colors.white54),
                SizedBox(height: 16),
                Text(
                  "Henüz favori şarkınız yok",
                  style: TextStyle(color: Colors.white),
                ),
              ],
            ),
          );
        }

        return ListView.builder(
          padding: const EdgeInsets.all(16),
          itemCount: favorites.length,
          itemBuilder: (context, index) {
            final song = favorites[index];
            return SongListTile(
              song: song,
              onAddToPlaylist: (id) =>
                  showPlaylistPicker(context, audioProvider, songId: id),
            );
          },
        );
      },
    );
  }
}



=========================================
FILE: lib\features\home\tabs\folder_detail_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../core/services/audio_provider.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/widgets/song_list_tile.dart';
import '../../player/mini_player.dart';
import '../../playlist/playlist_picker.dart';

class FolderDetailScreen extends StatelessWidget {
  final String folderPath;
  final String folderName;

  const FolderDetailScreen({
    super.key,
    required this.folderPath,
    required this.folderName,
  });

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);
    final folderSongs = audioProvider.getSongsFromFolder(folderPath);

    return Scaffold(
      backgroundColor: AppColors.background,
      appBar: AppBar(
        backgroundColor: AppColors.surface,
        title: Text(folderName, style: const TextStyle(color: Colors.white)),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () => Navigator.pop(context),
        ),
      ),
      body: Column(
        children: [
          Padding(
            padding: const EdgeInsets.all(16.0),
            child: Row(
              children: [
                Expanded(
                  child: ElevatedButton.icon(
                    onPressed: () {
                      audioProvider.playSongList(folderSongs, shuffle: false);
                    },
                    icon: const Icon(Icons.play_arrow),
                    label: const Text("Oynat"),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.surfaceLight,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 12),
                    ),
                  ),
                ),
                const SizedBox(width: 16),
                Expanded(
                  child: ElevatedButton.icon(
                    onPressed: () {
                      audioProvider.playSongList(folderSongs, shuffle: true);
                    },
                    icon: const Icon(Icons.shuffle),
                    label: const Text("Karıştır"),
                    style: ElevatedButton.styleFrom(
                      backgroundColor: AppColors.primary,
                      foregroundColor: Colors.white,
                      padding: const EdgeInsets.symmetric(vertical: 12),
                    ),
                  ),
                ),
              ],
            ),
          ),
          Expanded(
            child: ListView.builder(
              padding: const EdgeInsets.symmetric(horizontal: 16),
              itemCount: folderSongs.length,
              itemBuilder: (context, index) {
                final song = folderSongs[index];
                return SongListTile(
                  song: song,
                  onAddToPlaylist: (id) =>
                      showPlaylistPicker(context, audioProvider, songId: id),
                );
              },
            ),
          ),
          if (audioProvider.currentSong != null) const MiniPlayer(),
        ],
      ),
    );
  }
}



=========================================
FILE: lib\features\home\tabs\folder_tab.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../../core/services/audio_provider.dart';
import '../../../core/theme/app_colors.dart';
import 'folder_detail_screen.dart';

class FolderTab extends StatelessWidget {
  const FolderTab({super.key});

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);
    final folders = audioProvider.folders;

    if (folders.isEmpty) {
      return const Center(
        child: Text("Klasör bulunamadı", style: TextStyle(color: Colors.white)),
      );
    }

    return ListView.builder(
      padding: const EdgeInsets.all(16),
      itemCount: folders.length,
      itemBuilder: (context, index) {
        final folderPath = folders[index];
        final folderName = folderPath.split('/').last;
        final songCount = audioProvider.getSongsFromFolder(folderPath).length;

        return ListTile(
          leading: const Icon(Icons.folder, color: AppColors.primary),
          title: Text(
            folderName,
            style: const TextStyle(
              color: Colors.white,
              fontWeight: FontWeight.bold,
            ),
          ),
          subtitle: Text(
            "$songCount Şarkı • $folderPath",
            maxLines: 1,
            overflow: TextOverflow.ellipsis,
            style: const TextStyle(color: AppColors.textSecondary),
          ),
          onTap: () {
            Navigator.push(
              context,
              MaterialPageRoute(
                builder: (context) => FolderDetailScreen(
                  folderPath: folderPath,
                  folderName: folderName,
                ),
              ),
            );
          },
        );
      },
    );
  }
}



=========================================
FILE: lib\features\home\tabs\genre_detail_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:on_audio_query/on_audio_query.dart';
import 'package:provider/provider.dart';
import '../../../core/services/audio_provider.dart';
import '../../../core/theme/app_colors.dart';
import '../../player/mini_player.dart';
import '../../../core/mixins/auto_scroll_mixin.dart';
import '../../../core/widgets/song_list_tile.dart';
import '../../playlist/playlist_picker.dart';

class GenreDetailScreen extends StatefulWidget {
  final GenreModel genre;

  const GenreDetailScreen({super.key, required this.genre});

  @override
  State<GenreDetailScreen> createState() => _GenreDetailScreenState();
}

class _GenreDetailScreenState extends State<GenreDetailScreen>
    with AutoScrollMixin<GenreDetailScreen> {
  List<SongModel> _songs = [];
  bool _isLoading = true;
  final ScrollController _scrollController = ScrollController();
  final GlobalKey _scrollViewKey = GlobalKey();

  @override
  ScrollController get scrollController => _scrollController;

  @override
  int get itemCount => _songs.length;

  @override
  double get contentHeaderHeight => 280.0;

  @override
  void onSelectionRangeUpdate(int start, int end) {
    Provider.of<AudioProvider>(
      context,
      listen: false,
    ).selectRange(start, end, sourceList: _songs);
  }

  @override
  void initState() {
    super.initState();
    _fetchSongs();
  }

  @override
  void dispose() {
    _scrollController.dispose();
    super.dispose();
  }

  Future<void> _fetchSongs() async {
    final provider = Provider.of<AudioProvider>(context, listen: false);
    final songs = await provider.getSongsFromGenre(widget.genre.id);
    setState(() {
      _songs = songs; // _songs is used in handleSelectionUpdate
      _isLoading = false;
    });
  }

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);

    return Scaffold(
      bottomNavigationBar: audioProvider.isSelectionMode
          ? Container(
              color: AppColors.primary,
              padding: const EdgeInsets.symmetric(horizontal: 16, vertical: 12),
              child: Row(
                children: [
                  Text(
                    "${audioProvider.selectedSongIds.length} Seçildi",
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                  const Spacer(),
                  IconButton(
                    icon: const Icon(Icons.delete, color: Colors.white),
                    onPressed: () async {
                      final confirm = await showDialog<bool>(
                        context: context,
                        builder: (context) => AlertDialog(
                          backgroundColor: AppColors.surface,
                          title: const Text(
                            'Sil',
                            style: TextStyle(color: Colors.white),
                          ),
                          content: const Text(
                            'Seçili şarkıları silmek istediğinize emin misiniz?',
                            style: TextStyle(color: Colors.white),
                          ),
                          actions: [
                            TextButton(
                              onPressed: () => Navigator.pop(context, false),
                              child: const Text('Hayır'),
                            ),
                            TextButton(
                              onPressed: () => Navigator.pop(context, true),
                              child: const Text('Evet'),
                            ),
                          ],
                        ),
                      );

                      if (confirm == true) {
                        await audioProvider.deleteSelectedSongs();
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            const SnackBar(content: Text("Şarkılar silindi")),
                          );
                        }
                      }
                    },
                  ),
                  IconButton(
                    icon: const Icon(Icons.close, color: Colors.white),
                    onPressed: () => audioProvider.toggleSelectionMode(),
                  ),
                ],
              ),
            )
          : null,
      body: Column(
        children: [
          Expanded(
            child: CustomScrollView(
              key: _scrollViewKey,
              controller: _scrollController,
              slivers: [
                SliverAppBar(
                  expandedHeight: 200.0,
                  pinned: true,
                  backgroundColor: AppColors.background,
                  actions: [
                    IconButton(
                      icon: const Icon(
                        Icons.auto_awesome_motion,
                        color: AppColors.primary,
                      ),
                      tooltip: "Bu türden çalma listesi oluştur",
                      onPressed: () async {
                        final provider = Provider.of<AudioProvider>(
                          context,
                          listen: false,
                        );
                        await provider.createSmartPlaylistFromGenre(
                          widget.genre,
                        );
                        if (context.mounted) {
                          ScaffoldMessenger.of(context).showSnackBar(
                            SnackBar(
                              content: Text(
                                "${widget.genre.genre} türü çalma listelerine eklendi!",
                              ),
                            ),
                          );
                        }
                      },
                    ),
                  ],
                  flexibleSpace: FlexibleSpaceBar(
                    title: Text(
                      widget.genre.genre,
                      style: const TextStyle(color: Colors.white),
                    ),
                    background: Container(
                      color: AppColors.surfaceLight,
                      child: const Center(
                        child: Icon(
                          Icons.tag,
                          size: 80,
                          color: AppColors.textSecondary,
                        ),
                      ),
                    ),
                  ),
                ),
                if (_isLoading)
                  const SliverFillRemaining(
                    child: Center(
                      child: CircularProgressIndicator(
                        color: AppColors.primary,
                      ),
                    ),
                  )
                else if (_songs.isEmpty)
                  const SliverFillRemaining(
                    child: Center(
                      child: Text(
                        "Bu etikette şarkı bulunamadı",
                        style: TextStyle(color: Colors.white),
                      ),
                    ),
                  )
                else
                  SliverToBoxAdapter(
                    child: Padding(
                      padding: const EdgeInsets.all(16.0),
                      child: Row(
                        children: [
                          Expanded(
                            child: ElevatedButton.icon(
                              onPressed: () {
                                final provider = Provider.of<AudioProvider>(
                                  context,
                                  listen: false,
                                );
                                provider.playSongList(_songs, shuffle: false);
                              },
                              icon: const Icon(Icons.play_arrow),
                              label: const Text("Oynat"),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: AppColors.surfaceLight,
                                foregroundColor: Colors.white,
                                padding: const EdgeInsets.symmetric(
                                  vertical: 12,
                                ),
                              ),
                            ),
                          ),
                          const SizedBox(width: 16),
                          Expanded(
                            child: ElevatedButton.icon(
                              onPressed: () {
                                final provider = Provider.of<AudioProvider>(
                                  context,
                                  listen: false,
                                );
                                provider.playSongList(_songs, shuffle: true);
                              },
                              icon: const Icon(Icons.shuffle),
                              label: const Text("Karıştır"),
                              style: ElevatedButton.styleFrom(
                                backgroundColor: AppColors.primary,
                                foregroundColor: Colors.white,
                                padding: const EdgeInsets.symmetric(
                                  vertical: 12,
                                ),
                              ),
                            ),
                          ),
                        ],
                      ),
                    ),
                  ),
                SliverList(
                  delegate: SliverChildBuilderDelegate((context, index) {
                    final song = _songs[index];
                    return SongListTile(
                      song: song,
                      index: index,
                      onSelectionStart: (details, idx) {
                        audioProvider.toggleSelectionMode();
                        dragStartIndex = idx;
                        audioProvider.setDraggingSelection(true);
                        audioProvider.toggleSelection(song.id);
                      },
                      onSelectionUpdate: (details) {
                        if (dragStartIndex == null) return;
                        final RenderBox? box =
                            _scrollViewKey.currentContext?.findRenderObject()
                                as RenderBox?;
                        if (box != null) {
                          handleDragUpdate(
                            box.globalToLocal(details.globalPosition),
                            box.size.height,
                          );
                        }
                      },
                      onSelectionEnd: handleDragEnd,
                      onAddToPlaylist: (id) => showPlaylistPicker(
                        context,
                        audioProvider,
                        songId: id,
                      ),
                    );
                  }, childCount: _songs.length),
                ),
              ],
            ),
          ),
          if (audioProvider.currentSong != null) const MiniPlayer(),
        ],
      ),
    );
  }
}



=========================================
FILE: lib\features\home\tabs\genre_tab.dart
=========================================
import 'package:flutter/material.dart';
import '../../../core/theme/app_colors.dart';
import '../../../core/services/audio_provider.dart';
import 'genre_detail_screen.dart';

class GenreTab extends StatelessWidget {
  final AudioProvider audioProvider;

  const GenreTab({super.key, required this.audioProvider});

  @override
  Widget build(BuildContext context) {
    if (audioProvider.genres.isEmpty) {
      return const Center(
        child: Text("Etiket bulunamadı", style: TextStyle(color: Colors.white)),
      );
    }

    return RefreshIndicator(
      onRefresh: () async {
        await audioProvider.fetchGenres();
      },
      color: AppColors.primary,
      backgroundColor: AppColors.surface,
      child: GridView.builder(
        padding: const EdgeInsets.all(16),
        physics: const AlwaysScrollableScrollPhysics(),
        gridDelegate: const SliverGridDelegateWithFixedCrossAxisCount(
          crossAxisCount: 2,
          crossAxisSpacing: 16,
          mainAxisSpacing: 16,
          childAspectRatio: 1.5, // Wider aspect ratio for tags
        ),
        itemCount: audioProvider.genres.length,
        itemBuilder: (context, index) {
          final genre = audioProvider.genres[index];
          return InkWell(
            onTap: () {
              Navigator.push(
                context,
                MaterialPageRoute(
                  builder: (context) => GenreDetailScreen(genre: genre),
                ),
              );
            },
            borderRadius: BorderRadius.circular(16),
            child: Container(
              decoration: BoxDecoration(
                borderRadius: BorderRadius.circular(16),
                color: AppColors.surfaceLight,
              ),
              padding: const EdgeInsets.all(12),
              child: Column(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  const Icon(
                    Icons.tag,
                    size: 30,
                    color: AppColors.textSecondary,
                  ),
                  const SizedBox(height: 8),
                  Text(
                    genre.genre,
                    maxLines: 1,
                    overflow: TextOverflow.ellipsis,
                    textAlign: TextAlign.center,
                    style: const TextStyle(
                      color: Colors.white,
                      fontWeight: FontWeight.bold,
                      fontSize: 16,
                    ),
                  ),
                  Text(
                    "${genre.numOfSongs} Şarkı",
                    style: const TextStyle(
                      color: AppColors.textSecondary,
                      fontSize: 12,
                    ),
                  ),
                ],
              ),
            ),
          );
        },
      ),
    );
  }
}



=========================================
FILE: lib\features\player\mini_player.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:on_audio_query/on_audio_query.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';
import '../player/player_screen.dart';

class MiniPlayer extends StatelessWidget {
  const MiniPlayer({super.key});

  @override
  Widget build(BuildContext context) {
    return Consumer<AudioProvider>(
      builder: (context, audioProvider, child) {
        final song = audioProvider.currentSong;
        if (song == null) return const SizedBox.shrink();

        return GestureDetector(
          onTap: () {
            Navigator.push(
              context,
              MaterialPageRoute(builder: (context) => const PlayerScreen()),
            );
          },
          child: Container(
            height: 70,
            decoration: BoxDecoration(
              color: AppColors.surface,
              border: Border(
                top: BorderSide(color: AppColors.divider, width: 0.5),
              ),
              boxShadow: [
                BoxShadow(
                  color: Colors.black.withValues(alpha: 0.3),
                  blurRadius: 10,
                  offset: const Offset(0, -2),
                ),
              ],
            ),
            child: Row(
              children: [
                const SizedBox(width: 16),
                // Artwork
                Container(
                  width: 45,
                  height: 45,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(4),
                    color: AppColors.surfaceLight,
                  ),
                  child: QueryArtworkWidget(
                    id: song.id,
                    type: ArtworkType.AUDIO,
                    nullArtworkWidget: const Icon(Icons.music_note, size: 20),
                  ),
                ),
                const SizedBox(width: 12),
                // Info
                Expanded(
                  child: Column(
                    mainAxisAlignment: MainAxisAlignment.center,
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      Text(
                        song.title,
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                        style: const TextStyle(
                          color: AppColors.textPrimary,
                          fontWeight: FontWeight.w600,
                          fontSize: 14,
                        ),
                      ),
                      Text(
                        song.artist ?? "Unknown",
                        maxLines: 1,
                        overflow: TextOverflow.ellipsis,
                        style: const TextStyle(
                          color: AppColors.textSecondary,
                          fontSize: 12,
                        ),
                      ),
                    ],
                  ),
                ),
                // Controls
                IconButton(
                  icon: Icon(Icons.skip_previous, color: AppColors.textPrimary),
                  onPressed: () => audioProvider.playPrevious(),
                ),
                IconButton(
                  icon: Icon(
                    audioProvider.isPlaying
                        ? Icons.pause_circle_filled
                        : Icons.play_circle_filled,
                    color: AppColors.primary,
                    size: 36,
                  ),
                  onPressed: () {
                    audioProvider.isPlaying
                        ? audioProvider.pause()
                        : audioProvider.resume();
                  },
                ),
                IconButton(
                  icon: Icon(Icons.skip_next, color: AppColors.textPrimary),
                  onPressed: () => audioProvider.playNext(),
                ),
                const SizedBox(width: 8),
              ],
            ),
          ),
        );
      },
    );
  }
}



=========================================
FILE: lib\features\player\player_screen.dart
=========================================
import 'dart:ui';
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:just_audio/just_audio.dart';
import 'package:on_audio_query/on_audio_query.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';

class PlayerScreen extends StatefulWidget {
  const PlayerScreen({super.key});

  @override
  State<PlayerScreen> createState() => _PlayerScreenState();
}

class _PlayerScreenState extends State<PlayerScreen>
    with SingleTickerProviderStateMixin {
  bool _showLyrics = false;
  late AnimationController _rotationController;

  @override
  void initState() {
    super.initState();
    _rotationController = AnimationController(
      vsync: this,
      duration: const Duration(seconds: 10),
    );
  }

  @override
  void dispose() {
    _rotationController.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return Consumer<AudioProvider>(
      builder: (context, audioProvider, child) {
        final song = audioProvider.currentSong;
        if (song == null) return const SizedBox();

        // Check animation state
        if (audioProvider.isPlaying && !_rotationController.isAnimating) {
          _rotationController.repeat();
        } else if (!audioProvider.isPlaying &&
            _rotationController.isAnimating) {
          _rotationController.stop();
        }

        return Scaffold(
          body: Stack(
            children: [
              // 1. Blurred Background
              Container(
                decoration: const BoxDecoration(
                  gradient: LinearGradient(
                    begin: Alignment.topCenter,
                    end: Alignment.bottomCenter,
                    colors: [
                      AppColors.backgroundGradientStart,
                      AppColors.backgroundGradientEnd,
                    ],
                  ),
                ),
              ),
              Positioned.fill(
                child: Opacity(
                  opacity: 0.3,
                  child: QueryArtworkWidget(
                    id: song.id,
                    type: ArtworkType.AUDIO,
                    artworkFit: BoxFit.cover,
                    artworkHeight: double.infinity,
                    artworkWidth: double.infinity,
                    keepOldArtwork: true,
                    format: ArtworkFormat.JPEG,
                    size: 500, // Background can be higher res
                    nullArtworkWidget: const SizedBox(),
                  ),
                ),
              ),
              BackdropFilter(
                filter: ImageFilter.blur(sigmaX: 30, sigmaY: 30),
                child: Container(color: Colors.black.withValues(alpha: 0.5)),
              ),

              // 2. Content
              SafeArea(
                child: Column(
                  children: [
                    // Header
                    Padding(
                      padding: const EdgeInsets.symmetric(
                        horizontal: 16,
                        vertical: 8,
                      ),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          IconButton(
                            icon: const Icon(
                              Icons.keyboard_arrow_down,
                              size: 30,
                            ),
                            onPressed: () => Navigator.pop(context),
                          ),
                          const Text(
                            "Şu An Çalıyor",
                            style: TextStyle(
                              color: AppColors.textSecondary,
                              fontSize: 14,
                              letterSpacing: 1,
                            ),
                          ),
                          IconButton(
                            icon: Icon(
                              _showLyrics ? Icons.image : Icons.lyrics,
                              color: _showLyrics
                                  ? AppColors.primary
                                  : Colors.white,
                            ),
                            onPressed: () {
                              setState(() {
                                _showLyrics = !_showLyrics;
                              });
                            },
                          ),
                        ],
                      ),
                    ),

                    const Spacer(flex: 1),

                    // Artwork or Lyrics (Center)
                    AnimatedSwitcher(
                      duration: const Duration(milliseconds: 300),
                      child: _showLyrics
                          ? Container(
                              key: const ValueKey('lyrics'),
                              width: 300,
                              height: 350,
                              padding: const EdgeInsets.all(20),
                              decoration: BoxDecoration(
                                color: Colors.black.withValues(alpha: 0.3),
                                borderRadius: BorderRadius.circular(20),
                              ),
                              child: SingleChildScrollView(
                                child: Text(
                                  audioProvider.currentLyrics ??
                                      "Sözler bulunamadı.\n(Çevrimdışı .lrc dosyası ekleyebilirsiniz)",
                                  textAlign: TextAlign.center,
                                  style: const TextStyle(
                                    color: Colors.white,
                                    fontSize: 18,
                                    height: 1.5,
                                  ),
                                ),
                              ),
                            )
                          : Stack(
                              alignment: Alignment.center,
                              children: [
                                // Vinyl Record Outer Part
                                RotationTransition(
                                  turns: _rotationController,
                                  child: Container(
                                    width: 300,
                                    height: 300,
                                    decoration: BoxDecoration(
                                      shape: BoxShape.circle,
                                      gradient: RadialGradient(
                                        colors: [
                                          Colors.grey[900]!,
                                          Colors.black,
                                          Colors.grey[900]!,
                                          Colors.black,
                                        ],
                                        stops: const [0.0, 0.5, 0.8, 1.0],
                                      ),
                                      boxShadow: [
                                        BoxShadow(
                                          color: Colors.black.withValues(
                                            alpha: 0.5,
                                          ),
                                          blurRadius: 20,
                                          spreadRadius: 5,
                                        ),
                                      ],
                                    ),
                                    // Grooves
                                    child: Center(
                                      child: Container(
                                        width: 280,
                                        height: 280,
                                        decoration: BoxDecoration(
                                          shape: BoxShape.circle,
                                          border: Border.all(
                                            color: Colors.white.withValues(
                                              alpha: 0.05,
                                            ),
                                            width: 1,
                                          ),
                                        ),
                                        child: Center(
                                          child: Container(
                                            width: 250,
                                            height: 250,
                                            decoration: BoxDecoration(
                                              shape: BoxShape.circle,
                                              border: Border.all(
                                                color: Colors.white.withOpacity(
                                                  0.05,
                                                ),
                                                width: 1,
                                              ),
                                            ),
                                          ),
                                        ),
                                      ),
                                    ),
                                  ),
                                ),
                                // Album Art (Center)
                                RotationTransition(
                                  key: const ValueKey('artwork'),
                                  turns: _rotationController,
                                  child: Container(
                                    width: 180,
                                    height: 180,
                                    decoration: BoxDecoration(
                                      shape: BoxShape.circle,
                                      border: Border.all(
                                        color: Colors.black,
                                        width: 4,
                                      ),
                                    ),
                                    child: ClipOval(
                                      child: QueryArtworkWidget(
                                        id: song.id,
                                        type: ArtworkType.AUDIO,
                                        keepOldArtwork: true,
                                        format: ArtworkFormat.JPEG,
                                        size: 400,
                                        artworkFit: BoxFit.cover,
                                        nullArtworkWidget: Container(
                                          color: AppColors.surfaceLight,
                                          child: const Icon(
                                            Icons.music_note,
                                            size: 60,
                                            color: AppColors.textSecondary,
                                          ),
                                        ),
                                      ),
                                    ),
                                  ),
                                ),
                                // Hole in the middle (Stylized)
                                Container(
                                  width: 10,
                                  height: 10,
                                  decoration: const BoxDecoration(
                                    color: Colors.black,
                                    shape: BoxShape.circle,
                                  ),
                                ),
                              ],
                            ),
                    ),

                    const Spacer(flex: 1),

                    // Song Info
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 24),
                      child: Row(
                        mainAxisAlignment: MainAxisAlignment.center,
                        children: [
                          Expanded(
                            child: Column(
                              children: [
                                Text(
                                  song.title,
                                  textAlign: TextAlign.center,
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                  style: const TextStyle(
                                    fontSize: 24,
                                    fontWeight: FontWeight.bold,
                                    color: AppColors.textPrimary,
                                  ),
                                ),
                                const SizedBox(height: 8),
                                Text(
                                  song.artist ?? "Bilinmeyen Sanatçı",
                                  textAlign: TextAlign.center,
                                  maxLines: 1,
                                  overflow: TextOverflow.ellipsis,
                                  style: const TextStyle(
                                    fontSize: 16,
                                    color: AppColors.primary, // Neon accent
                                  ),
                                ),
                              ],
                            ),
                          ),
                          IconButton(
                            icon: Icon(
                              audioProvider.isFavorite(song.id)
                                  ? Icons.favorite
                                  : Icons.favorite_border,
                              color: audioProvider.isFavorite(song.id)
                                  ? AppColors.primary
                                  : Colors.white,
                            ),
                            onPressed: () =>
                                audioProvider.toggleFavorite(song.id),
                          ),
                        ],
                      ),
                    ),

                    const SizedBox(height: 30),

                    // Seek Bar
                    Padding(
                      padding: const EdgeInsets.symmetric(horizontal: 20),
                      child: StreamBuilder<PositionData>(
                        stream: audioProvider.positionDataStream,
                        builder: (context, snapshot) {
                          final positionData = snapshot.data;
                          final position =
                              positionData?.position ?? Duration.zero;
                          final duration =
                              positionData?.duration ?? Duration.zero;

                          return Column(
                            children: [
                              SliderTheme(
                                data: Theme.of(context).sliderTheme.copyWith(
                                  thumbShape: const RoundSliderThumbShape(
                                    enabledThumbRadius: 6,
                                  ),
                                  trackHeight: 4,
                                ),
                                child: Slider(
                                  activeColor: AppColors.primary,
                                  inactiveColor: Colors.white24,
                                  value: position.inSeconds.toDouble().clamp(
                                    0,
                                    duration.inSeconds.toDouble() + 1.0,
                                  ),
                                  max: (duration.inSeconds.toDouble() > 0)
                                      ? duration.inSeconds.toDouble() + 1.0
                                      : 1.0,
                                  onChanged: (value) {
                                    audioProvider.seek(
                                      Duration(seconds: value.toInt()),
                                    );
                                  },
                                ),
                              ),
                              Padding(
                                padding: const EdgeInsets.symmetric(
                                  horizontal: 10,
                                ),
                                child: Row(
                                  mainAxisAlignment:
                                      MainAxisAlignment.spaceBetween,
                                  children: [
                                    Text(
                                      _formatDuration(position),
                                      style: const TextStyle(
                                        color: AppColors.textSecondary,
                                        fontSize: 12,
                                      ),
                                    ),
                                    Text(
                                      _formatDuration(duration),
                                      style: const TextStyle(
                                        color: AppColors.textSecondary,
                                        fontSize: 12,
                                      ),
                                    ),
                                  ],
                                ),
                              ),
                            ],
                          );
                        },
                      ),
                    ),

                    const SizedBox(height: 20),

                    // Controls
                    Row(
                      mainAxisAlignment: MainAxisAlignment.spaceEvenly,
                      children: [
                        IconButton(
                          icon: Icon(
                            Icons.shuffle,
                            color: audioProvider.isShuffleMode
                                ? AppColors.primary
                                : AppColors.textSecondary,
                          ),
                          onPressed: () => audioProvider.toggleShuffle(),
                        ),
                        IconButton(
                          iconSize: 40,
                          icon: const Icon(
                            Icons.skip_previous,
                            color: AppColors.textPrimary,
                          ),
                          onPressed: () => audioProvider.playPrevious(),
                        ),
                        Container(
                          width: 70,
                          height: 70,
                          decoration: BoxDecoration(
                            color: AppColors.primary,
                            shape: BoxShape.circle,
                            boxShadow: [
                              BoxShadow(
                                color: AppColors.primary.withValues(alpha: 0.4),
                                blurRadius: 20,
                                spreadRadius: 2,
                              ),
                            ],
                          ),
                          child: IconButton(
                            iconSize: 32,
                            icon: Icon(
                              audioProvider.isPlaying
                                  ? Icons.pause
                                  : Icons.play_arrow,
                              color: Colors.black,
                            ),
                            onPressed: () {
                              audioProvider.isPlaying
                                  ? audioProvider.pause()
                                  : audioProvider.resume();
                            },
                          ),
                        ),
                        IconButton(
                          iconSize: 40,
                          icon: const Icon(
                            Icons.skip_next,
                            color: AppColors.textPrimary,
                          ),
                          onPressed: () => audioProvider.playNext(),
                        ),
                        IconButton(
                          icon: Icon(
                            audioProvider.loopMode == LoopMode.one
                                ? Icons.repeat_one
                                : Icons.repeat,
                            color: audioProvider.loopMode == LoopMode.off
                                ? AppColors.textSecondary
                                : AppColors.primary,
                          ),
                          onPressed: () => audioProvider.toggleRepeatMode(),
                        ),
                      ],
                    ),

                    const Spacer(flex: 1),
                  ],
                ),
              ),
            ],
          ),
        );
      },
    );
  }

  String _formatDuration(Duration duration) {
    String twoDigits(int n) => n.toString().padLeft(2, "0");
    String twoDigitMinutes = twoDigits(duration.inMinutes.remainder(60));
    String twoDigitSeconds = twoDigits(duration.inSeconds.remainder(60));
    return "$twoDigitMinutes:$twoDigitSeconds";
  }
}



=========================================
FILE: lib\features\playlist\create_playlist_dialog.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';

class CreatePlaylistDialog extends StatefulWidget {
  const CreatePlaylistDialog({super.key});

  @override
  State<CreatePlaylistDialog> createState() => _CreatePlaylistDialogState();
}

class _CreatePlaylistDialogState extends State<CreatePlaylistDialog> {
  final TextEditingController _controller = TextEditingController();

  @override
  void dispose() {
    _controller.dispose();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      backgroundColor: AppColors.surface,
      title: const Text(
        'Yeni Çalma Listesi',
        style: TextStyle(color: Colors.white),
      ),
      content: TextField(
        controller: _controller,
        style: const TextStyle(color: Colors.white),
        decoration: const InputDecoration(
          hintText: 'Liste adı',
          hintStyle: TextStyle(color: AppColors.textSecondary),
          enabledBorder: UnderlineInputBorder(
            borderSide: BorderSide(color: AppColors.textSecondary),
          ),
          focusedBorder: UnderlineInputBorder(
            borderSide: BorderSide(color: AppColors.primary),
          ),
        ),
      ),
      actions: [
        TextButton(
          onPressed: () => Navigator.pop(context),
          child: const Text(
            'İptal',
            style: TextStyle(color: AppColors.textSecondary),
          ),
        ),
        TextButton(
          onPressed: () {
            final name = _controller.text.trim();
            if (name.isNotEmpty) {
              Provider.of<AudioProvider>(
                context,
                listen: false,
              ).createPlaylist(name);
              Navigator.pop(context);
            }
          },
          child: const Text(
            'Oluştur',
            style: TextStyle(color: AppColors.primary),
          ),
        ),
      ],
    );
  }
}



=========================================
FILE: lib\features\playlist\playlist_detail_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:on_audio_query/on_audio_query.dart';
import 'package:provider/provider.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';
import '../../core/widgets/song_list_tile.dart';
import '../player/mini_player.dart';
import 'playlist_picker.dart';
import 'song_select_screen.dart';

class PlaylistDetailScreen extends StatefulWidget {
  final PlaylistModel playlist;

  const PlaylistDetailScreen({super.key, required this.playlist});

  @override
  State<PlaylistDetailScreen> createState() => _PlaylistDetailScreenState();
}

class _PlaylistDetailScreenState extends State<PlaylistDetailScreen> {
  List<SongModel> _songs = [];
  bool _isLoading = true;

  @override
  void initState() {
    super.initState();
    _loadSongs();
  }

  Future<void> _loadSongs() async {
    final audioProvider = Provider.of<AudioProvider>(context, listen: false);
    final songs = await audioProvider.getSongsFromPlaylist(widget.playlist.id);
    if (mounted) {
      setState(() {
        _songs = songs;
        _isLoading = false;
      });
    }
  }

  void _navigateToAddSongs(BuildContext context) async {
    final result = await Navigator.push(
      context,
      MaterialPageRoute(
        builder: (context) => SongSelectScreen(
          playlistId: widget.playlist.id,
          existingSongIds: _songs.map((s) => s.id).toList(),
        ),
      ),
    );

    if (result == true) {
      setState(() {
        _isLoading = true;
      });
      _loadSongs();
    }
  }

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);

    return Scaffold(
      backgroundColor: AppColors.background,
      appBar: AppBar(
        backgroundColor: AppColors.surface,
        title: Text(
          widget.playlist.playlist,
          style: const TextStyle(color: Colors.white),
        ),
        leading: IconButton(
          icon: const Icon(Icons.arrow_back, color: Colors.white),
          onPressed: () => Navigator.pop(context),
        ),
        actions: [
          IconButton(
            icon: const Icon(
              Icons.add_circle_outline,
              color: AppColors.primary,
            ),
            onPressed: () => _navigateToAddSongs(context),
          ),
        ],
      ),
      body: Column(
        children: [
          Expanded(
            child: _isLoading
                ? const Center(
                    child: CircularProgressIndicator(color: AppColors.primary),
                  )
                : _songs.isEmpty
                ? Center(
                    child: Column(
                      mainAxisAlignment: MainAxisAlignment.center,
                      children: [
                        const Icon(
                          Icons.playlist_add_check,
                          size: 64,
                          color: AppColors.surfaceLight,
                        ),
                        const SizedBox(height: 16),
                        const Text(
                          "Bu listede şarkı yok",
                          style: TextStyle(color: AppColors.textSecondary),
                        ),
                        const SizedBox(height: 24),
                        ElevatedButton.icon(
                          onPressed: () => _navigateToAddSongs(context),
                          icon: const Icon(Icons.add),
                          label: const Text("Şarkı Ekle"),
                          style: ElevatedButton.styleFrom(
                            backgroundColor: AppColors.primary,
                            foregroundColor: Colors.white,
                            shape: RoundedRectangleBorder(
                              borderRadius: BorderRadius.circular(20),
                            ),
                          ),
                        ),
                      ],
                    ),
                  )
                : Column(
                    children: [
                      Padding(
                        padding: const EdgeInsets.all(16.0),
                        child: Row(
                          children: [
                            Expanded(
                              child: ElevatedButton.icon(
                                onPressed: () {
                                  audioProvider.playSongList(
                                    _songs,
                                    shuffle: false,
                                  );
                                },
                                icon: const Icon(Icons.play_arrow),
                                label: const Text("Oynat"),
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: AppColors.surfaceLight,
                                  foregroundColor: Colors.white,
                                  padding: const EdgeInsets.symmetric(
                                    vertical: 12,
                                  ),
                                ),
                              ),
                            ),
                            const SizedBox(width: 16),
                            Expanded(
                              child: ElevatedButton.icon(
                                onPressed: () {
                                  audioProvider.playSongList(
                                    _songs,
                                    shuffle: true,
                                  );
                                },
                                icon: const Icon(Icons.shuffle),
                                label: const Text("Karıştır"),
                                style: ElevatedButton.styleFrom(
                                  backgroundColor: AppColors.primary,
                                  foregroundColor: Colors.white,
                                  padding: const EdgeInsets.symmetric(
                                    vertical: 12,
                                  ),
                                ),
                              ),
                            ),
                          ],
                        ),
                      ),
                      Expanded(
                        child: ListView.builder(
                          padding: const EdgeInsets.symmetric(horizontal: 16),
                          itemCount: _songs.length,
                          itemBuilder: (context, index) {
                            final song = _songs[index];
                            return SongListTile(
                              song: song,
                              onAddToPlaylist: (id) => showPlaylistPicker(
                                context,
                                audioProvider,
                                songId: id,
                              ),
                            );
                          },
                        ),
                      ),
                    ],
                  ),
          ),
          if (audioProvider.currentSong != null) const MiniPlayer(),
        ],
      ),
    );
  }
}



=========================================
FILE: lib\features\playlist\playlist_picker.dart
=========================================
import 'package:flutter/material.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';

void showPlaylistPicker(
  BuildContext context,
  AudioProvider audioProvider, {
  int? songId,
}) {
  showModalBottomSheet(
    context: context,
    backgroundColor: AppColors.surface,
    builder: (context) => ListView.builder(
      itemCount: audioProvider.playlists.length,
      itemBuilder: (context, index) {
        final playlist = audioProvider.playlists[index];
        return ListTile(
          leading: const Icon(Icons.playlist_play, color: Colors.white),
          title: Text(
            playlist.playlist,
            style: const TextStyle(color: Colors.white),
          ),
          onTap: () async {
            if (songId != null) {
              await audioProvider.addToPlaylist(playlist.id, songId);
            } else {
              await audioProvider.addSelectedToPlaylist(playlist.id);
            }

            if (context.mounted) {
              Navigator.pop(context);
              ScaffoldMessenger.of(context).showSnackBar(
                SnackBar(
                  content: Text(
                    songId != null
                        ? "Şarkı ${playlist.playlist} listesine eklendi"
                        : "Şarkılar ${playlist.playlist} listesine eklendi",
                  ),
                ),
              );
            }
          },
        );
      },
    ),
  );
}



=========================================
FILE: lib\features\playlist\playlist_tab.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';

import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';
import 'create_playlist_dialog.dart';
import 'playlist_detail_screen.dart';

class PlaylistTab extends StatelessWidget {
  const PlaylistTab({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.transparent,
      floatingActionButton: FloatingActionButton(
        onPressed: () {
          showDialog(
            context: context,
            builder: (context) => const CreatePlaylistDialog(),
          );
        },
        backgroundColor: AppColors.primary,
        child: const Icon(Icons.add, color: Colors.white),
      ),
      body: Consumer<AudioProvider>(
        builder: (context, audioProvider, child) {
          if (audioProvider.playlists.isEmpty) {
            return const Center(
              child: Text(
                'Çalma listesi yok',
                style: TextStyle(color: AppColors.textSecondary),
              ),
            );
          }

          return ListView.builder(
            padding: const EdgeInsets.all(16),
            itemCount: audioProvider.playlists.length,
            itemBuilder: (context, index) {
              final playlist = audioProvider.playlists[index];
              return ListTile(
                contentPadding: EdgeInsets.zero,
                leading: Container(
                  width: 50,
                  height: 50,
                  decoration: BoxDecoration(
                    borderRadius: BorderRadius.circular(8),
                    color: AppColors.surfaceLight,
                  ),
                  child: const Center(
                    child: Icon(
                      Icons.music_note,
                      color: AppColors.textSecondary,
                    ),
                  ),
                ),
                title: Text(
                  playlist.playlist,
                  style: const TextStyle(
                    color: Colors.white,
                    fontWeight: FontWeight.bold,
                  ),
                ),
                subtitle: Text(
                  "${playlist.numOfSongs} Şarkı",
                  style: const TextStyle(
                    color: AppColors.textSecondary,
                    fontSize: 12,
                  ),
                ),
                trailing: PopupMenuButton<String>(
                  icon: const Icon(
                    Icons.more_vert,
                    color: AppColors.textSecondary,
                  ),
                  onSelected: (value) async {
                    if (value == 'delete') {
                      await audioProvider.deletePlaylist(playlist.id);
                      if (context.mounted) {
                        ScaffoldMessenger.of(context).showSnackBar(
                          SnackBar(
                            content: Text("${playlist.playlist} silindi"),
                          ),
                        );
                      }
                    }
                  },
                  itemBuilder: (context) => [
                    const PopupMenuItem(value: 'delete', child: Text("Sil")),
                  ],
                ),
                onTap: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) =>
                          PlaylistDetailScreen(playlist: playlist),
                    ),
                  );
                },
              );
            },
          );
        },
      ),
    );
  }
}



=========================================
FILE: lib\features\playlist\song_select_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:on_audio_query/on_audio_query.dart';
import 'package:provider/provider.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';

class SongSelectScreen extends StatefulWidget {
  final int playlistId;
  final List<int> existingSongIds;

  const SongSelectScreen({
    super.key,
    required this.playlistId,
    required this.existingSongIds,
  });

  @override
  State<SongSelectScreen> createState() => _SongSelectScreenState();
}

class _SongSelectScreenState extends State<SongSelectScreen> {
  final Set<int> _selectedIds = {};

  @override
  Widget build(BuildContext context) {
    final audioProvider = Provider.of<AudioProvider>(context);
    final allSongs = audioProvider.songs;

    return Scaffold(
      backgroundColor: AppColors.background,
      appBar: AppBar(
        backgroundColor: AppColors.surface,
        title: const Text("Şarkı Seç", style: TextStyle(color: Colors.white)),
        actions: [
          if (_selectedIds.isNotEmpty)
            TextButton(
              onPressed: () async {
                await audioProvider.addSongsToPlaylist(
                  widget.playlistId,
                  _selectedIds.toList(),
                );
                if (context.mounted) {
                  Navigator.pop(context, true);
                }
              },
              child: const Text(
                "EKLE",
                style: TextStyle(
                  color: AppColors.primary,
                  fontWeight: FontWeight.bold,
                ),
              ),
            ),
        ],
      ),
      body: ListView.builder(
        itemCount: allSongs.length,
        itemBuilder: (context, index) {
          final song = allSongs[index];
          final isAlreadyIn = widget.existingSongIds.contains(song.id);
          final isSelected = _selectedIds.contains(song.id);

          return CheckboxListTile(
            value: isAlreadyIn || isSelected,
            onChanged: isAlreadyIn
                ? null
                : (value) {
                    setState(() {
                      if (value == true) {
                        _selectedIds.add(song.id);
                      } else {
                        _selectedIds.remove(song.id);
                      }
                    });
                  },
            activeColor: AppColors.primary,
            title: Text(
              song.title,
              maxLines: 1,
              overflow: TextOverflow.ellipsis,
              style: TextStyle(color: isAlreadyIn ? Colors.grey : Colors.white),
            ),
            subtitle: Text(
              song.artist ?? "Bilinmeyen Sanatçı",
              style: TextStyle(
                color: isAlreadyIn ? Colors.grey : AppColors.textSecondary,
              ),
            ),
            secondary: QueryArtworkWidget(
              id: song.id,
              type: ArtworkType.AUDIO,
              nullArtworkWidget: const Icon(
                Icons.music_note,
                color: AppColors.textSecondary,
              ),
            ),
          );
        },
      ),
    );
  }
}



=========================================
FILE: lib\features\settings\language_dialog.dart
=========================================
import 'package:flutter/material.dart';
import '../../core/theme/app_colors.dart';

class LanguageDialog extends StatefulWidget {
  const LanguageDialog({super.key});

  @override
  State<LanguageDialog> createState() => _LanguageDialogState();
}

class _LanguageDialogState extends State<LanguageDialog> {
  String _selectedLanguage = 'Türkçe';

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      backgroundColor: AppColors.surface,
      title: const Text('Dil Seçiniz', style: TextStyle(color: Colors.white)),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          _buildLanguageOption('Türkçe'),
          _buildLanguageOption('English'),
        ],
      ),
    );
  }

  Widget _buildLanguageOption(String language) {
    // ignore: deprecated_member_use
    return RadioListTile<String>(
      title: Text(language, style: const TextStyle(color: Colors.white)),
      value: language,
      groupValue: _selectedLanguage,
      activeColor: AppColors.primary,
      onChanged: (value) {
        setState(() {
          _selectedLanguage = value!;
        });
        Navigator.pop(context);
        // Implementing actual localization would require more setup (easy_localization or l10n)
        // For now this is a UI mock as requested.
      },
    );
  }
}



=========================================
FILE: lib\features\settings\settings_screen.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:image_picker/image_picker.dart';
import 'package:image_cropper/image_cropper.dart';
import '../../core/theme/app_colors.dart';
import '../equalizer/equalizer_screen.dart';
import '../../core/services/theme_provider.dart';

class SettingsScreen extends StatelessWidget {
  const SettingsScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Ayarlar'),
        backgroundColor: Colors.transparent,
        elevation: 0,
      ),
      extendBodyBehindAppBar: true,
      body: Container(
        decoration: BoxDecoration(
          gradient: LinearGradient(
            begin: Alignment.topCenter,
            end: Alignment.bottomCenter,
            colors: [
              Theme.of(context).primaryColor.withValues(alpha: 0.8),
              Theme.of(context).scaffoldBackgroundColor,
            ],
          ),
        ),
        child: SafeArea(
          child: ListView(
            padding: const EdgeInsets.all(16),
            children: [
              _buildSettingItem(
                context,
                icon: Icons.graphic_eq,
                title: 'Ekolayzer',
                subtitle: 'Ses ayarlarını düzenle',
                onTap: () {
                  Navigator.push(
                    context,
                    MaterialPageRoute(
                      builder: (context) => const EqualizerScreen(),
                    ),
                  );
                },
              ),
              const SizedBox(height: 16),
              _buildSettingItem(
                context,
                icon: Icons.image,
                title: 'Arkaplan Değiştir',
                subtitle: 'Kendi fotoğrafını yükle',
                onTap: () async {
                  final ImagePicker picker = ImagePicker();
                  final XFile? image = await picker.pickImage(
                    source: ImageSource.gallery,
                  );

                  if (image != null) {
                    final croppedFile = await ImageCropper().cropImage(
                      sourcePath: image.path,
                      aspectRatio: const CropAspectRatio(ratioX: 9, ratioY: 16),
                      uiSettings: [
                        AndroidUiSettings(
                          toolbarTitle: 'Düzenle',
                          toolbarColor: AppColors.background,
                          toolbarWidgetColor: Colors.white,
                          initAspectRatio: CropAspectRatioPreset.original,
                          lockAspectRatio: false,
                          backgroundColor: AppColors.background,
                          activeControlsWidgetColor: AppColors.primary,
                        ),
                        IOSUiSettings(title: 'Düzenle'),
                      ],
                    );

                    if (croppedFile != null && context.mounted) {
                      Provider.of<ThemeProvider>(
                        context,
                        listen: false,
                      ).setBackgroundImage(croppedFile.path);
                      ScaffoldMessenger.of(context).showSnackBar(
                        const SnackBar(content: Text('Arkaplan değiştirildi!')),
                      );
                    }
                  }
                },
              ),
              const SizedBox(height: 16),
              _buildSettingItem(
                context,
                icon: Icons.restore,
                title: 'Varsayılan Temaya Dön',
                subtitle: 'Gradyan arkaplanı geri yükle',
                onTap: () {
                  Provider.of<ThemeProvider>(
                    context,
                    listen: false,
                  ).setBackgroundImage(null);
                  ScaffoldMessenger.of(context).showSnackBar(
                    const SnackBar(
                      content: Text('Varsayılan tema geri yüklendi!'),
                    ),
                  );
                },
              ),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildSettingItem(
    BuildContext context, {
    required IconData icon,
    required String title,
    required String subtitle,
    required VoidCallback onTap,
  }) {
    return Container(
      decoration: BoxDecoration(
        color: Colors.white.withValues(alpha: 0.1),
        borderRadius: BorderRadius.circular(12),
      ),
      child: ListTile(
        leading: Icon(icon, color: Colors.white),
        title: Text(title, style: const TextStyle(color: Colors.white)),
        subtitle: Text(
          subtitle,
          style: TextStyle(color: Colors.white.withValues(alpha: 0.7)),
        ),
        trailing: const Icon(
          Icons.arrow_forward_ios,
          color: Colors.white,
          size: 16,
        ),
        onTap: onTap,
      ),
    );
  }
}



=========================================
FILE: lib\features\settings\sleep_timer_dialog.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import '../../core/services/audio_provider.dart';
import '../../core/theme/app_colors.dart';

class SleepTimerDialog extends StatelessWidget {
  const SleepTimerDialog({super.key});

  @override
  Widget build(BuildContext context) {
    return AlertDialog(
      backgroundColor: AppColors.surface,
      title: const Text(
        'Uyku Zamanlayıcısı',
        style: TextStyle(color: Colors.white),
      ),
      content: Column(
        mainAxisSize: MainAxisSize.min,
        children: [
          _buildOption(context, 'Kapat', null),
          _buildOption(context, '15 Dakika', const Duration(minutes: 15)),
          _buildOption(context, '30 Dakika', const Duration(minutes: 30)),
          _buildOption(context, '45 Dakika', const Duration(minutes: 45)),
          _buildOption(context, '1 Saat', const Duration(hours: 1)),
          _buildOption(context, '2 Saat', const Duration(hours: 2)),
        ],
      ),
    );
  }

  Widget _buildOption(BuildContext context, String title, Duration? duration) {
    return ListTile(
      title: Text(title, style: const TextStyle(color: Colors.white)),
      onTap: () {
        final provider = Provider.of<AudioProvider>(context, listen: false);
        if (duration == null) {
          provider.cancelSleepTimer();
        } else {
          provider.setSleepTimer(duration);
        }
        Navigator.pop(context);
      },
    );
  }
}



=========================================
FILE: lib\main.dart
=========================================
import 'package:flutter/material.dart';
import 'package:provider/provider.dart';
import 'package:just_audio_background/just_audio_background.dart';
import 'core/theme/app_theme.dart';
import 'core/services/audio_provider.dart';
import 'core/services/theme_provider.dart';
import 'core/widgets/splash_screen.dart';

Future<void> main() async {
  debugPrint("DEBUG: main: Starting...");
  WidgetsFlutterBinding.ensureInitialized();
  debugPrint("DEBUG: main: Binding initialized.");

  try {
    await JustAudioBackground.init(
      androidNotificationChannelId: 'com.ryanheise.bg_demo.channel.audio',
      androidNotificationChannelName: 'Audio Playback',
      androidNotificationOngoing: true,
      androidStopForegroundOnPause: true,
      androidNotificationIcon: "drawable/ic_notification",
    );
    debugPrint("DEBUG: main: JustAudioBackground initialized successfully.");
  } catch (e, stack) {
    debugPrint("DEBUG: main: JustAudioBackground init FAILED: $e");
    debugPrint("DEBUG: main: StackTrace: $stack");
  }

  runApp(const MyApp());
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MultiProvider(
      providers: [
        ChangeNotifierProvider(create: (_) => AudioProvider()),
        ChangeNotifierProvider(create: (_) => ThemeProvider()),
      ],
      child: MaterialApp(
        title: 'Müzik Çalar',
        debugShowCheckedModeBanner: false,
        theme: AppTheme.darkTheme,
        home: const SplashScreen(),
      ),
    );
  }
}



=========================================
FILE: pubspec.yaml
=========================================
name: modern_music_player
description: "A new Flutter project."
# The following line prevents the package from being accidentally published to
# pub.dev using `flutter pub publish`. This is preferred for private packages.
publish_to: 'none' # Remove this line if you wish to publish to pub.dev

# The following defines the version and build number for your application.
# A version number is three numbers separated by dots, like 1.2.43
# followed by an optional build number separated by a +.
# Both the version and the builder number may be overridden in flutter
# build by specifying --build-name and --build-number, respectively.
# In Android, build-name is used as versionName while build-number used as versionCode.
# Read more about Android versioning at https://developer.android.com/studio/publish/versioning
# In iOS, build-name is used as CFBundleShortVersionString while build-number is used as CFBundleVersion.
# Read more about iOS versioning at
# https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html
# In Windows, build-name is used as the major, minor, and patch parts
# of the product and file versions while build-number is used as the build suffix.
version: 1.0.0+1

environment:
  sdk: ^3.9.2

# Dependencies specify other packages that your package needs in order to work.
# To automatically upgrade your package dependencies to the latest versions
# consider running `flutter pub upgrade --major-versions`. Alternatively,
# dependencies can be manually updated by changing the version numbers below to
# the latest version available on pub.dev. To see which dependencies have newer
# versions available, run `flutter pub outdated`.
dependencies:
  flutter:
    sdk: flutter

  # The following adds the Cupertino Icons font to your application.
  # Use with the CupertinoIcons class for iOS style icons.
  cupertino_icons: ^1.0.8
  just_audio: ^0.10.5
  just_audio_background: ^0.0.1-beta.13
  on_audio_query: ^2.9.0
  equalizer_flutter: ^0.0.1
  image_cropper: ^8.0.0
  image_picker: ^1.0.7
  provider: ^6.1.5+1
  google_fonts: ^6.3.3
  permission_handler: ^12.0.1
  palette_generator: ^0.3.3+7
  animations: ^2.1.1
  shared_preferences: ^2.5.4
  rxdart: ^0.27.7
  dio: ^5.7.0
  path_provider: ^2.1.2
  audiotags: ^1.4.5
  audio_session: ^0.1.21
  flutter_svg: ^2.0.17

dev_dependencies:
  flutter_test:
    sdk: flutter

  # The "flutter_lints" package below contains a set of recommended lints to
  # encourage good coding practices. The lint set provided by the package is
  # activated in the `analysis_options.yaml` file located at the root of your
  # package. See that file for information about deactivating specific lint
  # rules and activating additional ones.
  flutter_lints: ^5.0.0

# For information on the generic Dart part of this file, see the
# following page: https://dart.dev/tools/pub/pubspec

# The following section is specific to Flutter packages.
flutter:

  # The following line ensures that the Material Icons font is
  # included with your application, so that you can use the icons in
  # the material Icons class.
  uses-material-design: true

  # To add assets to your application, add an assets section, like this:
  assets:
    - assets/logo.svg

  # An image asset can refer to one or more resolution-specific "variants", see
  # https://flutter.dev/to/resolution-aware-images

  # For details regarding adding assets from package dependencies, see
  # https://flutter.dev/to/asset-from-package

  # To add custom fonts to your application, add a fonts section here,
  # in this "flutter" section. Each entry in this list should have a
  # "family" key with the font family name, and a "fonts" key with a
  # list giving the asset and other descriptors for the font. For
  # example:
  # fonts:
  #   - family: Schyler
  #     fonts:
  #       - asset: fonts/Schyler-Regular.ttf
  #       - asset: fonts/Schyler-Italic.ttf
  #         style: italic
  #   - family: Trajan Pro
  #     fonts:
  #       - asset: fonts/TrajanPro.ttf
  #       - asset: fonts/TrajanPro_Bold.ttf
  #         weight: 700
  #
  # For details regarding fonts from package dependencies,
  # see https://flutter.dev/to/font-from-package



=========================================
FILE: android/app/src/main/AndroidManifest.xml
=========================================
<manifest xmlns:android="http://schemas.android.com/apk/res/android">
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.READ_MEDIA_AUDIO"/>
    <uses-permission android:name="android.permission.WAKE_LOCK"/>
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE"/>
    <uses-permission android:name="android.permission.FOREGROUND_SERVICE_MEDIA_PLAYBACK"/>
    <uses-permission android:name="android.permission.POST_NOTIFICATIONS"/>

    <application
        android:label="modern_music_player"
        android:name="${applicationName}"
        android:icon="@mipmap/ic_launcher"
        android:requestLegacyExternalStorage="true"
        android:enableOnBackInvokedCallback="true">
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTask"
            android:taskAffinity=""
            android:theme="@style/LaunchTheme"
            android:configChanges="orientation|keyboardHidden|keyboard|screenSize|smallestScreenSize|locale|layoutDirection|fontScale|screenLayout|density|uiMode"
            android:hardwareAccelerated="true"
            android:windowSoftInputMode="adjustResize">
            <!-- Specifies an Android theme to apply to this Activity as soon as
                 the Android process has started. This theme is visible to the user
                 while the Flutter UI initializes. After that, this theme continues
                 to determine the Window background behind the Flutter UI. -->
            <meta-data
              android:name="io.flutter.embedding.android.NormalTheme"
              android:resource="@style/NormalTheme"
              />
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>

        <activity
            android:name="com.yalantis.ucrop.UCropActivity"
            android:screenOrientation="portrait"
            android:theme="@style/Theme.AppCompat.Light.NoActionBar"/>

        <service android:name="com.ryanheise.audioservice.AudioService"
                 android:foregroundServiceType="mediaPlayback"
                 android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.STYLE_HELPER"/>
            </intent-filter>
        </service>

        <!-- Don't delete the meta-data below.
             This is used by the Flutter tool to generate GeneratedPluginRegistrant.java -->
        <meta-data
            android:name="flutterEmbedding"
            android:value="2" />
    </application>
    <!-- Required to query activities that can process text, see:
         https://developer.android.com/training/package-visibility and
         https://developer.android.com/reference/android/content/Intent#ACTION_PROCESS_TEXT.

         In particular, this is used by the Flutter engine in io.flutter.plugin.text.ProcessTextPlugin. -->
    <queries>
        <intent>
            <action android:name="android.intent.action.PROCESS_TEXT"/>
            <data android:mimeType="text/plain"/>
        </intent>
    </queries>
</manifest>



